<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Midnight">
<meta name="theme-color" content="#1b2838">
<title>Midnight Tracker</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231b2838'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>üåô</text></svg>">
<link rel="manifest" href="./manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Firebase SDKs ‚Äî same versions as Chelsea Tickets -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging-compat.js"></script>
<!-- XLSX for import -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
/* ===== Design system ‚Äî matches Chelsea Tickets ===== */
:root {
  --primary: #00b8a9;
  --primary-dark: #009e91;
  --primary-light: #e0f7f5;
  --navy: #1b2838;
  --navy-light: #243447;
  --text: #2d3748;
  --text-light: #718096;
  --bg: #f5f7fa;
  --white: #ffffff;
  --border: #e2e8f0;
  --warn: #d97706;
  --warn-bg: #fef3c7;
  --err: #dc2626;
  --err-bg: #fef2f2;
  --ok: #059669;
  --ok-bg: #ecfdf5;
  --blue: #2563eb;
  --blue-bg: #eff6ff;
  --purple: #7c3aed;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; min-height: 100vh; overflow-x: hidden; }
button { cursor: pointer; border: none; font: inherit; color: var(--text); }
input, select, textarea { font: inherit; color: var(--text); background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; }
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }

/* Header */
.header { background: var(--navy); padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
.header h1 { font-size: 18px; font-weight: 700; color: #fff; }
.header h1 span { color: var(--primary); }
.sync-status { font-size: 12px; color: rgba(255,255,255,.6); display: flex; align-items: center; gap: 4px; }
.sync-dot { width: 8px; height: 8px; border-radius: 50%; }
.sync-dot.ok { background: var(--ok); }
.sync-dot.pending { background: var(--warn); }
.sync-dot.error { background: var(--err); }

/* Tabs */
.tabs { display: flex; background: var(--white); border-bottom: 1px solid var(--border); }
.tab { flex: 1; padding: 12px 10px; text-align: center; background: none; color: var(--text-light); font-size: 13px; font-weight: 500; border-bottom: 2px solid transparent; transition: all .2s; }
.tab:hover { color: var(--text); }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); }

/* Multi-column list */
.list-controls { padding: 10px 16px; display: flex; gap: 8px; align-items: center; background: var(--white); border-bottom: 1px solid var(--border); }
.list-controls select { min-width: 120px; }
.list-controls .spacer { flex: 1; }
.list-controls .month-nav { display: flex; align-items: center; gap: 6px; }
.list-controls .month-nav button { background: var(--white); border: 1px solid var(--border); padding: 4px 10px; border-radius: 6px; font-size: 13px; transition: all .15s; }
.list-controls .month-nav button:hover { border-color: var(--primary); background: var(--primary-light); }
.list-controls .month-nav .current-range { font-size: 13px; font-weight: 600; color: var(--text); min-width: 140px; text-align: center; }

.months-scroll { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; height: calc(100vh - 110px); }
.months-scroll::-webkit-scrollbar { display: none; }
.month-col { min-width: 320px; max-width: 420px; flex: 1 0 320px; scroll-snap-align: start; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
.month-header { padding: 12px 16px; background: var(--bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 5; }
.month-header h2 { font-size: 15px; font-weight: 600; }
.month-header .month-summary { font-size: 12px; color: var(--text-light); margin-top: 2px; }
.month-days { flex: 1; overflow-y: auto; }

.list-item { display: flex; padding: 10px 16px; border-bottom: 1px solid var(--border); gap: 12px; cursor: pointer; transition: background .15s; background: var(--white); }
.list-item:hover { background: var(--primary-light); }
.list-item.is-today { background: var(--primary-light); border-left: 3px solid var(--primary); }
.list-item.is-home { opacity: .6; }
.list-date { min-width: 40px; text-align: center; }
.list-date .day-num { font-size: 16px; font-weight: 700; color: var(--primary); }
.list-date .day-name { font-size: 10px; color: var(--text-light); text-transform: uppercase; font-weight: 500; }
.list-info { flex: 1; min-width: 0; }
.list-info .place { font-weight: 500; font-size: 13px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-info .city-country { font-size: 12px; color: var(--text-light); }
.list-info .flights { font-size: 11px; color: var(--purple); margin-top: 1px; }
.list-info .working-tag { display: inline-block; font-size: 10px; background: var(--warn-bg); color: var(--warn); padding: 1px 6px; border-radius: 4px; margin-top: 2px; font-weight: 600; }
.list-flag { font-size: 16px; display: flex; align-items: center; }

/* On mobile: single column full width */
@media (max-width: 640px) {
  .month-col { min-width: 100vw; max-width: 100vw; flex: 0 0 100vw; }
}
/* Tablet: 2 columns */
@media (min-width: 641px) and (max-width: 960px) {
  .month-col { min-width: 50vw; max-width: 50vw; flex: 0 0 50vw; }
}
/* Desktop: 3+ columns */
@media (min-width: 961px) {
  .month-col { min-width: 320px; max-width: 380px; }
}

/* Stats */
.stats-container { padding: 16px; }
.stats-year-select { margin-bottom: 16px; }
.stat-card { background: var(--white); border-radius: 10px; border: 1px solid var(--border); padding: 18px; margin-bottom: 12px; }
.stat-card h3 { font-size: 14px; color: var(--text-light); margin-bottom: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: .3px; }
.stat-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
.stat-row .country { font-weight: 500; }
.stat-row .days { color: var(--primary); font-weight: 700; }
.stat-bar { height: 6px; background: var(--bg); border-radius: 3px; margin-top: 4px; }
.stat-bar-fill { height: 100%; border-radius: 3px; background: var(--primary); transition: width .5s; }

/* Modal */
.modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4); z-index: 200; align-items: flex-end; justify-content: center; }
.modal-bg.open { display: flex; }
.modal { background: var(--white); border-radius: 16px 16px 0 0; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; padding: 24px; box-shadow: 0 -8px 30px rgba(0,0,0,.15); }
.modal h2 { font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
.modal h2 button { background: none; font-size: 24px; color: var(--text-light); }
.field { margin-bottom: 14px; }
.field label { display: block; font-size: 13px; color: var(--text-light); margin-bottom: 4px; font-weight: 500; }
.field input, .field select, .field textarea { width: 100%; }
.btn { padding: 10px 20px; border-radius: 8px; font-weight: 500; font-size: 14px; transition: all .15s; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-danger { background: var(--err); color: #fff; }
.btn-outline { background: var(--white); border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover { background: var(--bg); }
.btn-row { display: flex; gap: 8px; margin-top: 16px; }
.btn-row .btn { flex: 1; }

/* Settings */
.settings-section { padding: 16px; }
.settings-section h3 { font-size: 14px; color: var(--text-light); margin-bottom: 12px; font-weight: 500; }
.settings-card { background: var(--white); border-radius: 10px; border: 1px solid var(--border); padding: 18px; margin-bottom: 16px; }
.settings-card h3 { font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
.settings-card p { font-size: 13px; color: var(--text-light); margin-bottom: 8px; }

/* Toast */
.toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--navy); color: #fff; padding: 12px 20px; border-radius: 8px; font-size: 14px; z-index: 300; opacity: 0; transition: opacity .3s; pointer-events: none; box-shadow: 0 8px 24px rgba(0,0,0,.2); }
.toast.show { opacity: 1; }

/* Login */
.login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: var(--bg); padding: 20px; }
.login-card { background: var(--white); border-radius: 16px; border: 1px solid var(--border); padding: 40px 32px; max-width: 380px; width: 100%; box-shadow: 0 4px 24px rgba(0,0,0,.08); text-align: center; }
.login-card .logo { font-size: 48px; margin-bottom: 12px; }
.login-card h1 { font-size: 22px; font-weight: 700; color: var(--navy); margin-bottom: 4px; }
.login-card h1 span { color: var(--primary); }
.login-card .subtitle { font-size: 13px; color: var(--text-light); margin-bottom: 28px; }
.login-card .field { text-align: left; }
.login-card .login-error { color: var(--err); font-size: 13px; margin-bottom: 12px; min-height: 20px; }
.app-wrap { display: none; }
.app-wrap.authed { display: block; }

/* Location presets */
.presets-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
.preset-btn { display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 10px; background: var(--bg); border: 1.5px solid var(--border); cursor: pointer; transition: all .15s; text-align: left; }
.preset-btn:hover { border-color: var(--primary); background: var(--primary-light); }
.preset-btn.selected { border-color: var(--primary); background: var(--primary-light); box-shadow: 0 0 0 1px var(--primary); }
.preset-btn .preset-icon { font-size: 22px; flex: none; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: var(--white); }
.preset-btn .preset-label { font-size: 13px; font-weight: 600; color: var(--text); line-height: 1.2; }
.preset-btn .preset-sub { font-size: 11px; color: var(--text-light); font-weight: 400; }
.custom-toggle { display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; border-radius: 10px; background: var(--bg); border: 1.5px dashed var(--border); cursor: pointer; font-size: 13px; color: var(--text-light); transition: all .15s; }
.custom-toggle:hover { border-color: var(--primary); color: var(--primary); }
.custom-toggle.selected { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
.detail-fields { display: none; }
.detail-fields.visible { display: block; }
.extras-row { display: flex; gap: 8px; margin-bottom: 14px; }
.extras-row .field { flex: 1; margin-bottom: 0; }

/* Sections */
.view { display: none; }
.view.active { display: block; }

/* Auto-GPS status banner */
.gps-banner { padding: 10px 16px; font-size: 12px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid var(--border); }
.gps-banner.ok { background: var(--ok-bg); color: var(--ok); }
.gps-banner.pending { background: var(--warn-bg); color: var(--warn); }
.gps-banner.error { background: var(--err-bg); color: var(--err); }
.gps-banner .gps-dismiss { margin-left: auto; background: none; font-size: 16px; color: inherit; opacity: .6; }

@media (min-width: 768px) {
  .modal { border-radius: 16px; margin-bottom: 20px; }
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="logo">üåô</div>
    <h1><span>Midnight</span> Tracker</h1>
    <div class="subtitle">Sign in to continue</div>
    <div class="field">
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="you@email.com" />
    </div>
    <div class="field">
      <label>Password</label>
      <input id="loginPassword" type="password" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()" />
    </div>
    <div class="login-error" id="loginError"></div>
    <button class="btn btn-primary" style="width:100%;padding:12px;" onclick="doLogin()">Sign in</button>
    <div id="resetSection" style="margin-top:16px;">
      <a href="#" onclick="showResetForm();return false" style="font-size:13px;color:var(--primary);">Forgot password?</a>
    </div>
    <div id="resetForm" style="display:none;margin-top:16px;text-align:left;">
      <div class="field">
        <label>Email address</label>
        <input id="resetEmail" type="email" placeholder="you@email.com" />
      </div>
      <div class="login-error" id="resetMsg"></div>
      <button class="btn btn-primary" style="width:100%;padding:10px;" onclick="doReset()">Send reset link</button>
      <div style="text-align:center;margin-top:10px;"><a href="#" onclick="hideResetForm();return false" style="font-size:13px;color:var(--text-light);">Back to sign in</a></div>
    </div>
  </div>
</div>

<!-- APP (hidden until authenticated) -->
<div class="app-wrap" id="appWrap">

<div class="header">
  <h1>üåô <span>Midnight</span> Tracker</h1>
  <div class="sync-status" id="syncStatus"><div class="sync-dot pending"></div>Connecting...</div>
</div>

<div class="tabs">
  <button class="tab active" data-view="list">Location</button>
  <button class="tab" data-view="stats">Tax stats</button>
  <button class="tab" data-view="settings">Settings</button>
</div>

<!-- GPS status banner (shown when auto-GPS needs attention) -->
<div class="gps-banner pending" id="gpsBanner" style="display:none;">
  <span id="gpsBannerText"></span>
  <button class="gps-dismiss" onclick="dismissGpsBanner()">&times;</button>
</div>

<!-- LIST VIEW (default, multi-column) -->
<div id="list" class="view active">
  <div class="list-controls">
    <select id="listCountryFilter"><option value="">All countries</option></select>
    <div class="spacer"></div>
    <div class="month-nav">
      <button onclick="scrollMonths(-1)">‚óÄ</button>
      <span class="current-range" id="monthRange"></span>
      <button onclick="scrollMonths(1)">‚ñ∂</button>
    </div>
  </div>
  <div class="months-scroll" id="monthsScroll"></div>
</div>

<!-- STATS VIEW -->
<div id="stats" class="view">
  <div class="stats-container">
    <select class="stats-year-select" id="statsYear" style="width:100%;margin-bottom:16px;"></select>
    <div id="statsContent"></div>
  </div>
</div>

<!-- SETTINGS VIEW -->
<div id="settings" class="view">
  <div class="settings-section">

    <div class="settings-card">
      <h3>Primary home</h3>
      <p style="margin-bottom:10px;">Days without a location entry are counted as home days.</p>
      <div class="extras-row">
        <div class="field"><label>Place</label><input id="homePlaceInput" /></div>
      </div>
      <div class="extras-row">
        <div class="field"><label>City</label><input id="homeCityInput" /></div>
        <div class="field"><label>Country</label><input id="homeCountryInput" /></div>
      </div>
      <button class="btn btn-outline" onclick="saveHomeSettings()" style="width:100%">Save home</button>
    </div>

    <div class="settings-card">
      <h3>Quick locations</h3>
      <p>Manage the quick-pick buttons shown when editing a day.</p>
      <div id="presetsList" style="margin:12px 0;"></div>
      <div id="presetFormArea" style="display:none;"></div>
      <button class="btn btn-outline" onclick="addPresetUI()" style="width:100%">+ Add location</button>
    </div>

    <div class="settings-card">
      <h3>Export data</h3>
      <button class="btn btn-outline" onclick="exportCSV()" style="width:100%">Export as CSV</button>
    </div>

    <div class="settings-card">
      <h3>Account</h3>
      <p id="loggedInAs" style="margin-bottom:8px;"></p>
      <button class="btn btn-outline" onclick="doLogout()" style="width:100%">Sign out</button>
    </div>

    <div style="margin-top:8px;text-align:center;">
      <a href="#" onclick="document.getElementById('advancedSettings').style.display=document.getElementById('advancedSettings').style.display==='none'?'block':'none';this.textContent=document.getElementById('advancedSettings').style.display==='none'?'Show advanced settings':'Hide advanced settings';return false" style="font-size:13px;color:var(--text-light);">Show advanced settings</a>
    </div>

    <div id="advancedSettings" style="display:none;">
      <div class="settings-card">
        <h3>Midnight GPS</h3>
        <p>The app captures GPS at midnight to log your location. A push notification wakes the app even when closed.</p>
        <div style="font-size:12px;padding:8px;background:var(--bg);border-radius:6px;margin:8px 0;">
          <strong>Status:</strong> <span id="pushStatus">Checking...</span>
        </div>
        <div class="field" style="margin-top:8px;">
          <label>VAPID key (from Firebase Cloud Messaging)</label>
          <input id="vapidKeyInput" placeholder="BL..." style="font-size:11px;" />
        </div>
        <button class="btn btn-outline" onclick="saveVapidKey()" style="width:100%;margin-bottom:8px;">Save VAPID key</button>
        <div class="field">
          <label>Teams webhook URL (for unrecognised locations)</label>
          <input id="teamsWebhookUrl" placeholder="https://outlook.office.com/webhook/..." style="font-size:12px;" />
        </div>
        <button class="btn btn-outline" onclick="saveTeamsWebhook()" style="width:100%;margin-bottom:8px;">Save webhook</button>
        <button class="btn btn-outline" onclick="testMidnightGPS()" style="width:100%;">Test GPS capture now</button>
      </div>

      <div class="settings-card">
        <h3>Firebase connection</h3>
        <p id="fbStatus" style="margin-bottom:8px;">Checking connection...</p>
        <button class="btn btn-primary" onclick="testFirebase()" style="width:100%">Test connection</button>
      </div>

      <div class="settings-card">
        <h3>Import spreadsheet</h3>
        <p>Import your existing Excel tracking spreadsheet. Format: Date | Day | Month | Year | Place | City | Country | Flights</p>
        <input type="file" id="importFile" accept=".xlsx,.csv" style="width:100%;margin-bottom:8px;" />
        <button class="btn btn-primary" onclick="importSpreadsheet()" style="width:100%">Import data</button>
      </div>
    </div>

  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-bg" id="editModal">
  <div class="modal">
    <h2><span id="modalDate"></span><button onclick="closeModal()">&times;</button></h2>

    <!-- Quick-pick presets -->
    <div class="presets-grid" id="presetsGrid"></div>

    <!-- Hotel shortcut: just type hotel name, city/country from preset -->
    <div id="hotelField" class="detail-fields" style="margin-bottom:14px;">
      <div class="field">
        <label>Hotel name</label>
        <input id="editHotelName" placeholder="e.g. Mandarin Oriental" />
      </div>
    </div>

    <!-- Custom / full form -->
    <div id="customFields" class="detail-fields">
      <div class="field">
        <label>Place / Address</label>
        <input id="editPlace" placeholder="e.g. 42 Acacia Avenue" />
      </div>
      <div class="field">
        <label>City</label>
        <input id="editCity" placeholder="e.g. Nice" />
      </div>
      <div class="field">
        <label>Country</label>
        <input id="editCountry" placeholder="e.g. France" />
      </div>
    </div>

    <!-- Always visible: flights, notes, working, GPS -->
    <div class="extras-row">
      <div class="field">
        <label>Flights</label>
        <input id="editFlights" placeholder="e.g. BA569" />
      </div>
      <div class="field">
        <label>Notes</label>
        <input id="editNotes" placeholder="Optional notes..." />
      </div>
    </div>
    <div class="field" id="workingField">
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
        <input type="checkbox" id="editWorking" style="width:18px;height:18px;accent-color:var(--primary);flex:none;" />
        <span>Worked in the UK this day</span>
      </label>
    </div>

    <div class="btn-row">
      <button class="btn btn-outline" onclick="clearDay()">Clear</button>
      <button class="btn btn-primary" onclick="saveDay()">Save</button>
    </div>
  </div>
</div>

</div><!-- /app-wrap -->

<div class="toast" id="toast"></div>

<script>
// ===== FIREBASE CONFIG =====
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAjZaVwXku1n1niJtkxvcKjXDHibSHHIRc",
  authDomain: "midnight-tracker-steve.firebaseapp.com",
  databaseURL: "https://midnight-tracker-steve-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "midnight-tracker-steve",
  storageBucket: "midnight-tracker-steve.firebasestorage.app",
  messagingSenderId: "860824921259",
  appId: "1:860824921259:web:b1c462b04dc3bf18ae03ee"
};

// ===== FIREBASE INIT =====
let db = null;
let auth = null;
let fbReady = false;
let currentUser = null;
try {
  if (FIREBASE_CONFIG.apiKey !== 'YOUR_API_KEY') {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.database();
    auth = firebase.auth();
    fbReady = true;
  }
} catch(e) { console.warn('Firebase init failed:', e); }

// ===== AUTH =====
function doLogin() {
  const email = document.getElementById('loginEmail').value.trim();
  const pw = document.getElementById('loginPassword').value;
  const errEl = document.getElementById('loginError');
  errEl.textContent = '';
  if (!email || !pw) { errEl.textContent = 'Enter email and password.'; return; }
  auth.signInWithEmailAndPassword(email, pw)
    .then(() => { /* onAuthStateChanged handles the rest */ })
    .catch(err => {
      console.warn('Login error:', err.code);
      if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
        errEl.textContent = 'Invalid email or password.';
      } else if (err.code === 'auth/too-many-requests') {
        errEl.textContent = 'Too many attempts. Try again later.';
      } else {
        errEl.textContent = 'Login failed. Please try again.';
      }
    });
}

function doLogout() {
  auth.signOut();
}

function showResetForm() {
  document.getElementById('resetSection').style.display = 'none';
  document.getElementById('resetForm').style.display = 'block';
  document.getElementById('resetEmail').value = document.getElementById('loginEmail').value;
  document.getElementById('resetMsg').textContent = '';
}

function hideResetForm() {
  document.getElementById('resetSection').style.display = 'block';
  document.getElementById('resetForm').style.display = 'none';
}

function doReset() {
  const email = document.getElementById('resetEmail').value.trim();
  const msgEl = document.getElementById('resetMsg');
  if (!email) { msgEl.textContent = 'Enter your email address.'; msgEl.style.color = 'var(--err)'; return; }
  auth.sendPasswordResetEmail(email)
    .then(() => {
      msgEl.textContent = 'Reset link sent! Check your inbox.';
      msgEl.style.color = 'var(--ok)';
    })
    .catch(() => {
      // Don't reveal whether the email exists
      msgEl.textContent = 'If that email is registered, a reset link has been sent.';
      msgEl.style.color = 'var(--ok)';
    });
}

function showApp(user) {
  currentUser = user;
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appWrap').classList.add('authed');
  document.getElementById('loggedInAs').textContent = 'Signed in as ' + user.email;
  loadLocal();
  loadPresets();
  loadHomeSettings();
  loadTeamsWebhook();
  render();
  initFirebaseSync();
  // Start midnight GPS system
  scheduleMidnightCapture();
  // Check if today needs a GPS capture (delayed to let Firebase sync first)
  setTimeout(checkTodayGPS, 3000);
  // Initialise push notifications
  loadVapidKey();
  setTimeout(initPushNotifications, 2000);
}

function showLogin() {
  currentUser = null;
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('appWrap').classList.remove('authed');
  // Clear state
  entries = {};
  if (db) db.ref('locations').off();
}

// Listen for auth state changes
if (auth) {
  auth.onAuthStateChanged(user => {
    if (user) {
      showApp(user);
    } else {
      showLogin();
    }
  });
}

function fbSet(path, val) { if (db) db.ref(path).set(val); }
function fbUpdate(path, val) { if (db) db.ref(path).update(val); }
function fbRemove(path) { if (db) db.ref(path).remove(); }
function fbListen(path, cb) {
  if (db) db.ref(path).on('value', snap => { const v = snap.val(); cb(v); });
}

// ===== STATE =====
let HOME = { city: 'Cernobbio', country: 'Italy', place: 'Home' };
let entries = {};
let editingDate = null;

// The "anchor" month for the scroll ‚Äî current month by default
let anchorYear, anchorMonth;
// How many months to show at once (we render a window of months)
const MONTHS_BUFFER = 6; // 3 past + current + 2 future
let scrollOffset = 0; // 0 = current month is first column

// ===== SYNC STATUS =====
function setSyncStatus(state, text) {
  const el = document.getElementById('syncStatus');
  el.innerHTML = '<div class="sync-dot ' + state + '"></div>' + text;
}

function testFirebase() {
  const statusEl = document.getElementById('fbStatus');
  if (!fbReady) {
    statusEl.textContent = 'Firebase not configured. Edit FIREBASE_CONFIG in index.html.';
    statusEl.style.color = 'var(--err)';
    return;
  }
  statusEl.textContent = 'Testing connection...';
  statusEl.style.color = 'var(--warn)';
  db.ref('.info/connected').once('value', snap => {
    if (snap.val() === true) {
      statusEl.textContent = 'Connected to Firebase (' + FIREBASE_CONFIG.projectId + ')';
      statusEl.style.color = 'var(--ok)';
    } else {
      statusEl.textContent = 'Firebase initialised but not connected yet.';
      statusEl.style.color = 'var(--warn)';
    }
  });
}

// ===== LOCAL STORAGE =====
function saveLocal() { localStorage.setItem('mt_entries', JSON.stringify(entries)); }
function loadLocal() {
  try { entries = JSON.parse(localStorage.getItem('mt_entries') || '{}'); } catch { entries = {}; }
}

// ===== FIREBASE SYNC =====
function initFirebaseSync() {
  if (!fbReady) {
    setSyncStatus('error', 'Not configured');
    document.getElementById('fbStatus').textContent = 'Firebase not configured. Edit FIREBASE_CONFIG in index.html.';
    document.getElementById('fbStatus').style.color = 'var(--err)';
    return;
  }
  setSyncStatus('pending', 'Syncing...');
  fbListen('locations', data => {
    if (data) {
      const newEntries = {};
      Object.keys(data).forEach(dateKey => {
        newEntries[dateKey] = { ...data[dateKey], synced: true };
      });
      entries = newEntries;
    } else {
      entries = {};
    }
    saveLocal();
    setSyncStatus('ok', 'Synced');
    render();
  });
  db.ref('.info/connected').on('value', snap => {
    if (snap.val() === true) {
      setSyncStatus('ok', 'Connected');
    } else {
      setSyncStatus('pending', 'Reconnecting...');
    }
  });
}

function syncEntry(date, entry) {
  if (!fbReady) return;
  const data = {
    place: entry.place || '', city: entry.city || '', country: entry.country || '',
    flights: entry.flights || '', notes: entry.notes || ''
  };
  if (entry.lat) data.lat = entry.lat;
  if (entry.lon) data.lon = entry.lon;
  if (entry.working) data.working = true;
  if (entry.autoGps) data.autoGps = true;
  if (entry.unconfirmed) data.unconfirmed = true;
  if (entry.autoBooking) data.autoBooking = true;
  if (entry.countryConflict) data.countryConflict = entry.countryConflict;
  fbSet('locations/' + date, data);
  entry.synced = true;
  saveLocal();
}

function deleteEntry(date) {
  if (fbReady) fbRemove('locations/' + date);
}

// ===== TABS =====
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.view).classList.add('active');
    render();
  });
});

// ===== MULTI-COLUMN LIST =====
const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAY_NAMES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function getMonthKey(y, m) { return y + '-' + String(m + 1).padStart(2, '0'); }

function scrollMonths(dir) {
  scrollOffset += dir;
  renderList();
}

function renderList() {
  const container = document.getElementById('monthsScroll');
  const countryFilter = document.getElementById('listCountryFilter').value;
  const todayStr = fmtDate(new Date());

  // Populate country filter
  const countries = [...new Set(Object.values(entries).map(e => e.country).filter(Boolean))].sort();
  const sel = document.getElementById('listCountryFilter');
  const current = sel.value;
  sel.innerHTML = '<option value="">All countries</option>' + countries.map(c => '<option value="' + c + '"' + (c === current ? ' selected' : '') + '>' + c + '</option>').join('');

  // Build months array: scrollOffset controls which month is first
  // scrollOffset 0 = current month first, -1 = last month first, +1 = next month first
  let html = '';
  const startY = anchorYear;
  const startM = anchorMonth;

  for (let i = 0; i < MONTHS_BUFFER; i++) {
    let mOffset = scrollOffset + i;
    let y = startY;
    let m = startM + mOffset;
    // Normalise month/year
    while (m > 11) { m -= 12; y++; }
    while (m < 0) { m += 12; y--; }

    const daysInMonth = new Date(y, m + 1, 0).getDate();
    let monthHtml = '';
    let awayDays = 0;
    let homeDays = 0;

    for (let d = 1; d <= daysInMonth; d++) {
      const ds = y + '-' + String(m + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
      const dt = new Date(y, m, d);
      const entry = entries[ds];
      const place = entry?.place || HOME.place;
      const city = entry?.city || HOME.city;
      const country = entry?.country || HOME.country;
      const flights = entry?.flights || '';
      const flag = entry?.country ? countryFlag(entry.country) : countryFlag(HOME.country);
      const isHome = (!entry) || (entry.country === HOME.country && entry.city === HOME.city);
      const isToday = ds === todayStr;

      if (isHome) homeDays++; else awayDays++;
      if (countryFilter && country !== countryFilter) continue;

      let cls = 'list-item';
      if (isToday) cls += ' is-today';
      if (isHome) cls += ' is-home';

      const isWorking = entry?.working;
      const isUnconfirmed = entry?.unconfirmed;
      monthHtml += '<div class="' + cls + '" onclick="openDay(\'' + ds + '\')">' +
        '<div class="list-date"><div class="day-num">' + d + '</div><div class="day-name">' + DAY_NAMES[dt.getDay()] + '</div></div>' +
        '<div class="list-info"><div class="place">' + place + '</div><div class="city-country">' + city + (country ? ', ' + country : '') + '</div>' +
        (flights ? '<div class="flights">‚úà ' + flights + '</div>' : '') +
        (entry?.lat ? '<div style="font-size:10px;color:var(--text-light);font-family:monospace;">' + entry.lat.toFixed(5) + ', ' + entry.lon.toFixed(5) + '</div>' : '') +
        (isWorking ? '<div class="working-tag">WORKING</div>' : '') +
        (isUnconfirmed ? '<div class="working-tag" style="background:var(--err-bg);color:var(--err);">UNCONFIRMED</div>' : '') +
        (entry?.autoBooking ? '<div class="working-tag" style="background:#e8f0fe;color:#1a73e8;">AUTO-BOOKING</div>' : '') +
        (entry?.countryConflict ? '<div class="working-tag" style="background:#fff3cd;color:#856404;">‚ö† COUNTRY MISMATCH</div>' : '') + '</div>' +
        '<div class="list-flag">' + flag + '</div>' +
      '</div>';
    }

    html += '<div class="month-col">' +
      '<div class="month-header"><h2>' + MONTH_NAMES[m] + ' ' + y + '</h2>' +
      '<div class="month-summary">' + awayDays + ' away ¬∑ ' + homeDays + ' home</div></div>' +
      '<div class="month-days">' + (monthHtml || '<p style="padding:16px;color:var(--text-light)">No entries</p>') + '</div>' +
    '</div>';
  }

  container.innerHTML = html;

  // Update range label
  let firstM = startM + scrollOffset;
  let firstY = startY;
  while (firstM > 11) { firstM -= 12; firstY++; }
  while (firstM < 0) { firstM += 12; firstY--; }
  document.getElementById('monthRange').textContent = MONTH_NAMES[firstM].slice(0, 3) + ' ' + firstY;
}

document.getElementById('listCountryFilter').addEventListener('change', renderList);

function countryFlag(country) {
  const map = {
    'Italy':'üáÆüáπ','UK':'üá¨üáß','Thailand':'üáπüá≠','Japan':'üáØüáµ','Taiwan':'üáπüáº',
    'India':'üáÆüá≥','Switzerland':'üá®üá≠','France':'üá´üá∑','Germany':'üá©üá™','Spain':'üá™üá∏',
    'USA':'üá∫üá∏','United States':'üá∫üá∏','China':'üá®üá≥','Australia':'üá¶üá∫','Canada':'üá®üá¶',
    'Singapore':'üá∏üá¨','UAE':'üá¶üá™','Netherlands':'üá≥üá±','Portugal':'üáµüáπ','Greece':'üá¨üá∑',
    'Turkey':'üáπüá∑','Brazil':'üáßüá∑','Mexico':'üá≤üáΩ','South Korea':'üá∞üá∑','Indonesia':'üáÆüá©',
    'Malaysia':'üá≤üáæ','Vietnam':'üáªüá≥','Philippines':'üáµüá≠','Hong Kong':'üá≠üá∞',
  };
  return map[country] || 'üè≥Ô∏è';
}

// ===== STATS (UK Tax Year: 6 Apr ‚Äì 5 Apr) =====

// Get tax year label from a start year, e.g. 2025 => "2025/26"
function taxYearLabel(startYear) {
  return startYear + '/' + String(startYear + 1).slice(2);
}

// Tax year start: 6 April of startYear. End: 5 April of startYear+1.
function taxYearDates(startYear) {
  return {
    start: new Date(startYear, 3, 6),  // 6 April
    end: new Date(startYear + 1, 3, 5) // 5 April next year
  };
}

// Total days in a tax year (365 or 366 depending on whether it spans a leap year)
function taxYearTotalDays(startYear) {
  const { start, end } = taxYearDates(startYear);
  return Math.round((end - start) / 86400000) + 1;
}

// Which tax year does today fall in?
function currentTaxYear() {
  const now = new Date();
  // If before 6 April, we're in the tax year that started last year
  if (now.getMonth() < 3 || (now.getMonth() === 3 && now.getDate() < 6)) {
    return now.getFullYear() - 1;
  }
  return now.getFullYear();
}

function renderStats() {
  const sel = document.getElementById('statsYear');
  // Build list of tax years from data
  const dataYears = Object.keys(entries).map(d => {
    const dt = new Date(d + 'T00:00:00');
    if (dt.getMonth() < 3 || (dt.getMonth() === 3 && dt.getDate() < 6)) return dt.getFullYear() - 1;
    return dt.getFullYear();
  });
  const taxYears = [...new Set([currentTaxYear(), ...dataYears])].sort().reverse();

  if (!sel.options.length || sel.dataset.count !== String(taxYears.length)) {
    sel.innerHTML = taxYears.map(y => '<option value="' + y + '">' + taxYearLabel(y) + ' (6 Apr ' + y + ' ‚Äì 5 Apr ' + (y+1) + ')</option>').join('');
    sel.value = currentTaxYear();
    sel.dataset.count = String(taxYears.length);
  }

  const startYear = parseInt(sel.value);
  const { start: taxStart, end: taxEnd } = taxYearDates(startYear);
  const today = new Date();
  const lastDay = taxEnd < today ? taxEnd : today;
  const totalTaxDays = taxYearTotalDays(startYear);

  // Count days per country within the tax year
  const countryCounts = {};
  let daysElapsed = 0;
  let ukNights = 0;
  let italyDays = 0;
  let ukWorkDays = 0;

  for (let d = new Date(taxStart); d <= lastDay; d.setDate(d.getDate() + 1)) {
    const ds = fmtDate(d);
    const entry = entries[ds];
    const country = entry?.country || HOME.country;
    countryCounts[country] = (countryCounts[country] || 0) + 1;
    daysElapsed++;
    if (country === 'UK') ukNights++;
    if (country === 'Italy') italyDays++;
    if (entry?.working) ukWorkDays++;
  }

  const daysRemaining = totalTaxDays - daysElapsed;
  const sorted = Object.entries(countryCounts).sort((a, b) => b[1] - a[1]);
  const maxDays = sorted[0]?.[1] || 1;

  // ‚îÄ‚îÄ Country breakdown ‚îÄ‚îÄ
  let html = '<div class="stat-card"><h3>Midnights per country ‚Äî tax year ' + taxYearLabel(startYear) + '</h3>';
  html += '<div style="font-size:12px;color:var(--text-light);margin-bottom:10px;">' + daysElapsed + ' days elapsed ¬∑ ' + daysRemaining + ' days remaining</div>';
  sorted.forEach(([country, days]) => {
    const pct = ((days / daysElapsed) * 100).toFixed(1);
    const barW = ((days / maxDays) * 100).toFixed(0);
    const flag = countryFlag(country);
    html += '<div class="stat-row"><span class="country">' + flag + ' ' + country + '</span><span class="days">' + days + ' nights (' + pct + '%)</span></div>' +
            '<div class="stat-bar"><div class="stat-bar-fill" style="width:' + barW + '%"></div></div>';
  });
  html += '</div>';

  // ‚îÄ‚îÄ Italy 183-day target ‚îÄ‚îÄ
  const italyProjected = daysElapsed > 0 ? Math.round((italyDays / daysElapsed) * totalTaxDays) : 0;
  const italyNeeded = Math.max(0, 183 - italyDays);
  const italyOnTrack = italyProjected >= 183;
  const italyPct = ((italyDays / 183) * 100).toFixed(0);

  html += '<div class="stat-card"><h3>üáÆüáπ Italy ‚Äî 183-day residency target</h3>';
  html += '<div class="stat-bar" style="height:10px;margin-bottom:12px;"><div class="stat-bar-fill" style="width:' + Math.min(100, italyPct) + '%;background:' + (italyOnTrack ? 'var(--ok)' : 'var(--warn)') + '"></div></div>';
  html += '<div class="stat-row"><span>Nights in Italy (actual)</span><span class="days">' + italyDays + ' / 183</span></div>';
  html += '<div class="stat-row"><span>Projected full tax year</span><span class="days" style="color:' + (italyOnTrack ? 'var(--ok)' : 'var(--warn)') + '">' + italyProjected + '</span></div>';
  if (italyNeeded > 0) {
    html += '<div class="stat-row"><span>Still needed</span><span class="days" style="color:var(--warn)">' + italyNeeded + ' more nights</span></div>';
    if (daysRemaining > 0) {
      const italyPaceNeeded = (italyNeeded / daysRemaining * 100).toFixed(0);
      html += '<div class="stat-row"><span>Required pace</span><span style="color:var(--text-light)">' + italyPaceNeeded + '% of remaining days in Italy</span></div>';
    }
  } else {
    html += '<div class="stat-row"><span>Status</span><span class="days" style="color:var(--ok)">‚úì Target met!</span></div>';
  }
  html += '</div>';

  // ‚îÄ‚îÄ UK 90-night limit ‚îÄ‚îÄ
  const ukProjected = daysElapsed > 0 ? Math.round((ukNights / daysElapsed) * totalTaxDays) : 0;
  const ukRemaining = Math.max(0, 90 - ukNights);
  const ukSafe = ukProjected <= 90;
  const ukPct = ((ukNights / 90) * 100).toFixed(0);

  html += '<div class="stat-card"><h3>üá¨üáß UK ‚Äî 90-night limit</h3>';
  html += '<div class="stat-bar" style="height:10px;margin-bottom:12px;"><div class="stat-bar-fill" style="width:' + Math.min(100, ukPct) + '%;background:' + (ukNights > 90 ? 'var(--err)' : ukSafe ? 'var(--ok)' : 'var(--warn)') + '"></div></div>';
  html += '<div class="stat-row"><span>UK midnights (actual)</span><span class="days">' + ukNights + ' / 90</span></div>';
  html += '<div class="stat-row"><span>Projected full tax year</span><span class="days" style="color:' + (ukSafe ? 'var(--ok)' : 'var(--err)') + '">' + ukProjected + '</span></div>';
  if (ukNights > 90) {
    html += '<div class="stat-row"><span>Status</span><span class="days" style="color:var(--err)">‚ö† LIMIT EXCEEDED by ' + (ukNights - 90) + ' nights</span></div>';
  } else {
    html += '<div class="stat-row"><span>Nights remaining</span><span class="days">' + ukRemaining + ' UK nights available</span></div>';
    if (daysRemaining > 0 && ukRemaining > 0) {
      const avgDaysBetweenUK = Math.round(daysRemaining / ukRemaining);
      html += '<div class="stat-row"><span>Budget</span><span style="color:var(--text-light)">~1 UK night every ' + avgDaysBetweenUK + ' days</span></div>';
    }
  }
  html += '</div>';

  // ‚îÄ‚îÄ UK 30-day working limit ‚îÄ‚îÄ
  const ukWorkRemaining = Math.max(0, 30 - ukWorkDays);
  const ukWorkProjected = daysElapsed > 0 ? Math.round((ukWorkDays / daysElapsed) * totalTaxDays) : 0;
  const ukWorkSafe = ukWorkProjected <= 30;
  const ukWorkPct = ((ukWorkDays / 30) * 100).toFixed(0);

  html += '<div class="stat-card"><h3>üá¨üáß UK ‚Äî 30-day working limit</h3>';
  html += '<div class="stat-bar" style="height:10px;margin-bottom:12px;"><div class="stat-bar-fill" style="width:' + Math.min(100, ukWorkPct) + '%;background:' + (ukWorkDays > 30 ? 'var(--err)' : ukWorkSafe ? 'var(--ok)' : 'var(--warn)') + '"></div></div>';
  html += '<div class="stat-row"><span>UK working days (actual)</span><span class="days">' + ukWorkDays + ' / 30</span></div>';
  html += '<div class="stat-row"><span>Projected full tax year</span><span class="days" style="color:' + (ukWorkSafe ? 'var(--ok)' : 'var(--err)') + '">' + ukWorkProjected + '</span></div>';
  if (ukWorkDays > 30) {
    html += '<div class="stat-row"><span>Status</span><span class="days" style="color:var(--err)">‚ö† LIMIT EXCEEDED by ' + (ukWorkDays - 30) + ' days</span></div>';
  } else {
    html += '<div class="stat-row"><span>Days remaining</span><span class="days">' + ukWorkRemaining + ' UK work days available</span></div>';
  }
  html += '<div style="font-size:11px;color:var(--text-light);margin-top:8px;">Tag UK working days in the edit modal (defaults to not working)</div>';
  html += '</div>';

  document.getElementById('statsContent').innerHTML = html;
}

document.getElementById('statsYear').addEventListener('change', renderStats);

// ===== LOCATION PRESETS =====
// type: 'fixed' = one-click fill, 'hotel' = asks for hotel name, 'custom' = full form
const DEFAULT_PRESETS = [
  { id: 'home', icon: 'üè†', label: 'Home', sub: 'Cernobbio, Italy', type: 'fixed', place: 'Home', city: 'Cernobbio', country: 'Italy' },
  { id: 'oxford', icon: 'üá¨üáß', label: 'Oxford', sub: 'UK', type: 'fixed', place: 'Oxford', city: 'Oxford', country: 'UK' },
  { id: 'bangkok', icon: 'üáπüá≠', label: 'Bangkok', sub: 'Klongsan, Thailand', type: 'fixed', place: 'Baan Sathorn Chaophraya', city: 'Bangkok', country: 'Thailand' },
];
let presets = [...DEFAULT_PRESETS];
let selectedPreset = null;

function loadPresets() {
  try {
    const saved = localStorage.getItem('mt_presets');
    if (saved) presets = JSON.parse(saved);
  } catch(e) {}
  // Also listen to Firebase for shared presets
  if (fbReady) {
    fbListen('presets', data => {
      if (data && Array.isArray(data)) {
        presets = data;
        localStorage.setItem('mt_presets', JSON.stringify(presets));
      }
    });
  }
}

function savePresets() {
  localStorage.setItem('mt_presets', JSON.stringify(presets));
  if (fbReady) fbSet('presets', presets);
  renderPresetsSettings();
}

// ===== PRESET MANAGEMENT (Settings) =====
function renderPresetsSettings() {
  const el = document.getElementById('presetsList');
  if (!el) return;
  if (!presets.length) { el.innerHTML = '<p style="color:var(--text-light);font-size:13px;">No presets yet.</p>'; return; }
  el.innerHTML = presets.map((p, i) =>
    '<div style="display:flex;align-items:center;gap:10px;padding:10px 8px;border-bottom:1px solid var(--border);">' +
      '<span style="font-size:18px;">' + p.icon + '</span>' +
      '<div style="flex:1;min-width:0;">' +
        '<div style="font-size:13px;font-weight:600;">' + p.label + '</div>' +
        '<div style="font-size:11px;color:var(--text-light);">' + (p.place ? p.place + ', ' : '') + p.city + ', ' + p.country + ' ¬∑ ' + (p.type === 'hotel' ? 'Hotel' : 'Fixed') + '</div>' +
      '</div>' +
      '<button class="btn btn-outline" style="padding:4px 8px;font-size:12px;" onclick="editPresetUI(' + i + ')">Edit</button>' +
      '<button class="btn btn-outline" style="padding:4px 8px;font-size:12px;color:var(--err);border-color:var(--err);" onclick="removePreset(' + i + ')">√ó</button>' +
    '</div>'
  ).join('');

  // Also populate home fields
  const hp = document.getElementById('homePlaceInput');
  const hc = document.getElementById('homeCityInput');
  const hco = document.getElementById('homeCountryInput');
  if (hp) hp.value = HOME.place;
  if (hc) hc.value = HOME.city;
  if (hco) hco.value = HOME.country;
}

function removePreset(idx) {
  if (!confirm('Remove "' + presets[idx].label + '"?')) return;
  presets.splice(idx, 1);
  savePresets();
}

function editPresetUI(idx) {
  const p = presets[idx];
  showPresetForm(p, function(data) {
    presets[idx] = { ...p, ...data, sub: data.city + ', ' + data.country };
    savePresets();
    toast('Updated ' + data.label);
  });
}

function addPresetUI() {
  showPresetForm(null, function(data) {
    const id = data.label.toLowerCase().replace(/[^a-z0-9]/g, '_') + '_' + Date.now();
    presets.push({ id, ...data, sub: data.city + ', ' + data.country });
    savePresets();
    toast('Added ' + data.label);
  });
}

function showPresetForm(existing, onSave) {
  const p = existing || { icon: 'üìç', label: '', place: '', city: '', country: '', type: 'fixed' };
  const el = document.getElementById('presetFormArea');
  el.innerHTML =
    '<div style="background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:16px;margin-top:12px;">' +
      '<div style="font-size:14px;font-weight:600;margin-bottom:12px;">' + (existing ? 'Edit location' : 'Add location') + '</div>' +
      '<div style="display:grid;grid-template-columns:60px 1fr;gap:8px 12px;align-items:center;">' +
        '<label style="font-size:12px;color:var(--text-light);text-align:right;">Icon</label>' +
        '<input id="pf_icon" class="form-input" style="width:60px;" value="' + (p.icon||'') + '">' +
        '<label style="font-size:12px;color:var(--text-light);text-align:right;">Name</label>' +
        '<input id="pf_label" class="form-input" placeholder="e.g. Paris, Bangkok" value="' + (p.label||'') + '">' +
        '<label style="font-size:12px;color:var(--text-light);text-align:right;">Place</label>' +
        '<input id="pf_place" class="form-input" placeholder="Address or hotel name" value="' + (p.place||'') + '">' +
        '<label style="font-size:12px;color:var(--text-light);text-align:right;">City</label>' +
        '<input id="pf_city" class="form-input" placeholder="City" value="' + (p.city||'') + '">' +
        '<label style="font-size:12px;color:var(--text-light);text-align:right;">Country</label>' +
        '<input id="pf_country" class="form-input" placeholder="Country" value="' + (p.country||'') + '">' +
        '<label style="font-size:12px;color:var(--text-light);text-align:right;">Type</label>' +
        '<select id="pf_type" class="form-input">' +
          '<option value="fixed"' + (p.type==='fixed'?' selected':'') + '>Fixed (one-click)</option>' +
          '<option value="hotel"' + (p.type==='hotel'?' selected':'') + '>Hotel city (asks hotel name)</option>' +
        '</select>' +
      '</div>' +
      '<div style="display:flex;gap:8px;margin-top:14px;justify-content:flex-end;">' +
        '<button class="btn btn-outline" onclick="closePresetForm()">Cancel</button>' +
        '<button class="btn" onclick="submitPresetForm()">Save</button>' +
      '</div>' +
    '</div>';
  el.style.display = 'block';
  el._onSave = onSave;
  document.getElementById('pf_label').focus();
}

function closePresetForm() {
  const el = document.getElementById('presetFormArea');
  el.innerHTML = '';
  el.style.display = 'none';
}

function submitPresetForm() {
  const label = document.getElementById('pf_label').value.trim();
  const city = document.getElementById('pf_city').value.trim();
  const country = document.getElementById('pf_country').value.trim();
  if (!label || !city || !country) { toast('Name, city and country are required'); return; }
  const data = {
    icon: document.getElementById('pf_icon').value.trim() || 'üìç',
    label: label,
    place: document.getElementById('pf_place').value.trim(),
    city: city,
    country: country,
    type: document.getElementById('pf_type').value
  };
  const el = document.getElementById('presetFormArea');
  if (el._onSave) el._onSave(data);
  closePresetForm();
}

// ===== HOME SETTINGS =====
function saveHomeSettings() {
  const place = document.getElementById('homePlaceInput').value.trim();
  const city = document.getElementById('homeCityInput').value.trim();
  const country = document.getElementById('homeCountryInput').value.trim();
  if (!city || !country) { toast('City and country are required'); return; }
  HOME.place = place || 'Home';
  HOME.city = city;
  HOME.country = country;
  localStorage.setItem('mt_home', JSON.stringify(HOME));
  if (fbReady) fbSet('settings/home', { place: HOME.place, city: HOME.city, country: HOME.country });
  render();
  toast('Home updated: ' + HOME.city + ', ' + HOME.country);
}

function loadHomeSettings() {
  try {
    const saved = JSON.parse(localStorage.getItem('mt_home'));
    if (saved) { HOME.place = saved.place; HOME.city = saved.city; HOME.country = saved.country; }
  } catch(e) {}
  if (fbReady) {
    fbListen('settings/home', data => {
      if (data) {
        HOME.place = data.place || 'Home';
        HOME.city = data.city || 'Cernobbio';
        HOME.country = data.country || 'Italy';
        localStorage.setItem('mt_home', JSON.stringify(HOME));
        render();
      }
    });
  }
}

function renderPresets(existingEntry) {
  const grid = document.getElementById('presetsGrid');
  let html = '';
  presets.forEach(p => {
    html += '<button class="preset-btn" data-preset="' + p.id + '" onclick="selectPreset(\'' + p.id + '\')">' +
      '<div class="preset-icon">' + p.icon + '</div>' +
      '<div><div class="preset-label">' + p.label + '</div><div class="preset-sub">' + p.sub + '</div></div>' +
    '</button>';
  });
  // "Other" button for custom/friend's house
  html += '<button class="custom-toggle" onclick="selectPreset(\'custom\')">' +
    '‚úèÔ∏è Other place</button>';
  grid.innerHTML = html;

  // If existing entry matches a preset, highlight it
  if (existingEntry && existingEntry.city) {
    const match = presets.find(p =>
      p.city === existingEntry.city && p.country === existingEntry.country &&
      (p.type === 'fixed' ? p.place === existingEntry.place : true)
    );
    if (match) {
      selectPreset(match.id, existingEntry);
      return;
    }
    // Entry exists but doesn't match any preset ‚Äî show custom
    selectPreset('custom', existingEntry);
  }
}

function selectPreset(id, existingEntry) {
  selectedPreset = id;
  // Clear highlights
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('selected'));
  document.querySelector('.custom-toggle')?.classList.remove('selected');

  const hotelField = document.getElementById('hotelField');
  const customFields = document.getElementById('customFields');
  hotelField.classList.remove('visible');
  customFields.classList.remove('visible');

  if (id === 'custom') {
    document.querySelector('.custom-toggle')?.classList.add('selected');
    customFields.classList.add('visible');
    if (existingEntry) {
      document.getElementById('editPlace').value = existingEntry.place || '';
      document.getElementById('editCity').value = existingEntry.city || '';
      document.getElementById('editCountry').value = existingEntry.country || '';
    } else {
      document.getElementById('editPlace').value = '';
      document.getElementById('editCity').value = '';
      document.getElementById('editCountry').value = '';
    }
    document.getElementById('editPlace').focus();
    return;
  }

  const preset = presets.find(p => p.id === id);
  if (!preset) return;

  // Highlight the selected button
  const btn = document.querySelector('[data-preset="' + id + '"]');
  if (btn) btn.classList.add('selected');

  if (preset.type === 'fixed') {
    // One-click: fill hidden fields
    document.getElementById('editPlace').value = preset.place || '';
    document.getElementById('editCity').value = preset.city || '';
    document.getElementById('editCountry').value = preset.country || '';
  } else if (preset.type === 'hotel') {
    // Show hotel name input, pre-fill city/country
    hotelField.classList.add('visible');
    document.getElementById('editHotelName').value = existingEntry?.place || '';
    document.getElementById('editCity').value = preset.city;
    document.getElementById('editCountry').value = preset.country;
    document.getElementById('editPlace').value = existingEntry?.place || '';
    setTimeout(() => document.getElementById('editHotelName').focus(), 100);
  }
}

// ===== MODAL =====
function openDay(dateStr) {
  editingDate = dateStr;
  const entry = entries[dateStr] || {};
  document.getElementById('modalDate').textContent = formatDisplayDate(dateStr);
  // Reset hidden fields
  document.getElementById('editPlace').value = entry.place || '';
  document.getElementById('editCity').value = entry.city || '';
  document.getElementById('editCountry').value = entry.country || '';
  document.getElementById('editFlights').value = entry.flights || '';
  document.getElementById('editNotes').value = entry.notes || '';
  document.getElementById('editWorking').checked = !!entry.working;
  document.getElementById('editHotelName').value = '';
  selectedPreset = null;

  // Hide detail sections by default
  document.getElementById('hotelField').classList.remove('visible');
  document.getElementById('customFields').classList.remove('visible');

  // Render presets and auto-match existing entry
  renderPresets(entry.city ? entry : null);

  document.getElementById('editModal').classList.add('open');
}

function closeModal() {
  document.getElementById('editModal').classList.remove('open');
  editingDate = null;
}

function saveDay() {
  if (!editingDate) return;
  const savedDate = editingDate;

  // If hotel preset, use hotel name as place
  let place = document.getElementById('editPlace').value.trim();
  if (selectedPreset && selectedPreset !== 'custom') {
    const preset = presets.find(p => p.id === selectedPreset);
    if (preset?.type === 'hotel') {
      place = document.getElementById('editHotelName').value.trim() || preset.city;
    }
  }

  const existing = entries[savedDate];
  const entry = {
    place: place,
    city: document.getElementById('editCity').value.trim(),
    country: document.getElementById('editCountry').value.trim(),
    flights: document.getElementById('editFlights').value.trim(),
    notes: document.getElementById('editNotes').value.trim(),
    working: document.getElementById('editWorking').checked ? true : false,
    synced: false
  };
  // Preserve GPS if it was already set
  if (existing?.lat) entry.lat = existing.lat;
  if (existing?.lon) entry.lon = existing.lon;
  // Manual save clears auto-GPS flags
  // (no autoGps, no unconfirmed = manually confirmed)

  if (entry.place || entry.city || entry.country) {
    entries[savedDate] = entry;
    syncEntry(savedDate, entry);
  }
  saveLocal();
  closeModal();
  render();
  toast('Saved ' + formatDisplayDate(savedDate));
}

function clearDay() {
  if (!editingDate) return;
  const savedDate = editingDate;
  delete entries[savedDate];
  deleteEntry(savedDate);
  saveLocal();
  closeModal();
  render();
  toast('Cleared ' + formatDisplayDate(savedDate));
}

// ===== AUTO-GPS MIDNIGHT SYSTEM =====

// Known location coordinates for preset matching (lat, lon, radius in km)
const KNOWN_LOCATIONS = [
  { lat: 45.8472, lon: 9.0853, radius: 50, preset: 'home' },    // Cernobbio, Italy
  { lat: 51.7520, lon: -1.2577, radius: 50, preset: 'oxford' },  // Oxford, UK
  { lat: 13.7235, lon: 100.4925, radius: 50, preset: 'bangkok' }, // Klongsan/Bangkok
];

// Haversine distance in km
function gpsDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// Match GPS coordinates to a known preset
function matchLocationToPreset(lat, lon) {
  for (const loc of KNOWN_LOCATIONS) {
    const dist = gpsDistance(lat, lon, loc.lat, loc.lon);
    if (dist <= loc.radius) {
      const preset = presets.find(p => p.id === loc.preset);
      if (preset) return { preset, distance: dist };
    }
  }
  return null;
}

// Teams webhook
let teamsWebhookUrl = '';
function loadTeamsWebhook() {
  teamsWebhookUrl = localStorage.getItem('mt_teams_webhook') || '';
  const el = document.getElementById('teamsWebhookUrl');
  if (el) el.value = teamsWebhookUrl;
  // Also sync from Firebase
  if (fbReady) {
    fbListen('settings/teamsWebhook', data => {
      if (data) {
        teamsWebhookUrl = data;
        localStorage.setItem('mt_teams_webhook', data);
        const el2 = document.getElementById('teamsWebhookUrl');
        if (el2) el2.value = data;
      }
    });
  }
}

function saveTeamsWebhook() {
  teamsWebhookUrl = document.getElementById('teamsWebhookUrl').value.trim();
  localStorage.setItem('mt_teams_webhook', teamsWebhookUrl);
  if (fbReady) fbSet('settings/teamsWebhook', teamsWebhookUrl);
  toast('Webhook saved');
}

async function sendTeamsAlert(message) {
  if (!teamsWebhookUrl) { console.warn('No Teams webhook configured'); return; }
  try {
    await fetch(teamsWebhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        '@type': 'MessageCard',
        '@context': 'http://schema.org/extensions',
        themeColor: '00b8a9',
        summary: 'Midnight Tracker',
        sections: [{
          activityTitle: 'Midnight Tracker ‚Äî Location Check',
          activityImage: 'https://img.icons8.com/fluency/48/moon-satellite.png',
          text: message
        }]
      })
    });
    console.log('Teams alert sent');
  } catch(e) {
    console.warn('Teams webhook failed:', e);
  }
}

// Core auto-GPS function
async function autoGPSCapture(dateStr) {
  if (!navigator.geolocation) {
    showGpsBanner('error', 'GPS not available on this device.');
    return;
  }

  // Don't overwrite a manually-set entry (one that has a city but wasn't auto-captured)
  const existing = entries[dateStr];
  if (existing && existing.city && !existing.autoGps) {
    console.log('Skipping auto-GPS for ' + dateStr + ' ‚Äî already manually set');
    return;
  }

  showGpsBanner('pending', 'Capturing GPS for ' + formatDisplayDate(dateStr) + '...');

  return new Promise(resolve => {
    navigator.geolocation.getCurrentPosition(
      async pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        console.log('GPS captured:', lat, lon);

        // Try to match against known presets
        const match = matchLocationToPreset(lat, lon);

        if (match) {
          // Recognised location ‚Äî auto-fill from preset
          const p = match.preset;
          const entry = {
            place: p.place || p.city, city: p.city, country: p.country,
            flights: existing?.flights || '', notes: existing?.notes || '',
            working: existing?.working || false,
            lat, lon, autoGps: true, synced: false
          };
          // Check for country conflict with existing booking data
          if (existing && existing.country && existing.autoBooking && existing.country !== p.country) {
            entry.countryConflict = 'GPS says ' + p.country + ', booking says ' + existing.country;
            sendTeamsAlert(
              '**Country mismatch** on ' + formatDisplayDate(dateStr) + '.<br><br>' +
              'GPS location: **' + p.city + ', ' + p.country + '**<br>' +
              'Booking expected: **' + existing.city + ', ' + existing.country + '**<br><br>' +
              'Please check <a href="https://midnight.cancomo.com">midnight.cancomo.com</a> and confirm the correct country.'
            );
          }
          // Preserve flight info from booking
          if (existing?.flights && !entry.flights) entry.flights = existing.flights;
          entries[dateStr] = entry;
          syncEntry(dateStr, entry);
          saveLocal();
          render();
          showGpsBanner('ok', 'Auto-logged: ' + p.label + ' (' + match.distance.toFixed(1) + 'km away)' +
            (entry.countryConflict ? ' ‚ö† Country mismatch with booking!' : ''));
          setTimeout(dismissGpsBanner, entry.countryConflict ? 10000 : 5000);
          resolve(true);
        } else {
          // Unknown location ‚Äî reverse geocode and flag
          let city = '', country = '', placeName = '';
          try {
            const r = await fetch('https://nominatim.openstreetmap.org/reverse?lat=' + lat + '&lon=' + lon + '&format=json&accept-language=en');
            const data = await r.json();
            city = data.address?.city || data.address?.town || data.address?.village || '';
            country = data.address?.country || '';
            placeName = data.display_name?.split(',')[0] || '';
          } catch(e) { console.warn('Geocode failed', e); }

          // Save with what we have, flagged as unconfirmed
          const entry = {
            place: placeName, city, country,
            flights: existing?.flights || '', notes: existing?.notes || '',
            working: existing?.working || false,
            lat, lon, autoGps: true, unconfirmed: true, synced: false
          };
          // Check for country conflict with existing booking data
          if (existing && existing.country && existing.autoBooking && country && existing.country !== country) {
            entry.countryConflict = 'GPS says ' + country + ', booking says ' + existing.country;
          }
          entries[dateStr] = entry;
          syncEntry(dateStr, entry);
          saveLocal();
          render();

          const locDesc = (city ? city + ', ' : '') + (country || lat.toFixed(4) + ', ' + lon.toFixed(4));
          showGpsBanner('error', 'Unknown location: ' + locDesc + '. Please confirm where you were.');

          // Send Teams alert
          const dateDisplay = formatDisplayDate(dateStr);
          sendTeamsAlert(
            '**Unrecognised midnight location** on ' + dateDisplay + '.<br><br>' +
            'GPS: ' + lat.toFixed(5) + ', ' + lon.toFixed(5) + '<br>' +
            'Detected: **' + locDesc + '**<br><br>' +
            'Please open <a href="https://midnight.cancomo.com">midnight.cancomo.com</a> and confirm where Steve was at midnight.'
          );
          resolve(false);
        }
      },
      err => {
        console.warn('GPS error:', err.message);
        showGpsBanner('error', 'GPS failed: ' + err.message);
        // Send Teams alert about GPS failure
        sendTeamsAlert(
          '**GPS capture failed** for ' + formatDisplayDate(dateStr) + '.<br><br>' +
          'Error: ' + err.message + '<br><br>' +
          'Please open <a href="https://midnight.cancomo.com">midnight.cancomo.com</a> and manually log the location.'
        );
        resolve(false);
      },
      { enableHighAccuracy: true, timeout: 15000 }
    );
  });
}

function showGpsBanner(type, text) {
  const banner = document.getElementById('gpsBanner');
  banner.style.display = 'flex';
  banner.className = 'gps-banner ' + type;
  document.getElementById('gpsBannerText').textContent = text;
}

function dismissGpsBanner() {
  document.getElementById('gpsBanner').style.display = 'none';
}

// Schedule GPS capture at midnight
let midnightTimer = null;
function scheduleMidnightCapture() {
  if (midnightTimer) clearTimeout(midnightTimer);
  const now = new Date();
  const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 5); // 5 seconds past midnight
  const ms = midnight - now;
  console.log('Next midnight GPS capture in ' + Math.round(ms / 60000) + ' minutes');
  midnightTimer = setTimeout(() => {
    const dateStr = fmtDate(new Date());
    console.log('Midnight! Auto-capturing GPS for ' + dateStr);
    autoGPSCapture(dateStr).then(() => {
      // Schedule the next one
      scheduleMidnightCapture();
    });
  }, ms);
}

// On app load, check if today needs auto-GPS
function checkTodayGPS() {
  const todayStr = fmtDate(new Date());
  const existing = entries[todayStr];
  // If no entry for today, or entry was auto-GPS and unconfirmed, try capturing
  if (!existing || (!existing.city && !existing.place)) {
    console.log('No entry for today, auto-capturing GPS...');
    autoGPSCapture(todayStr);
  }
}

// ===== PUSH NOTIFICATIONS (FCM) =====
let messaging = null;
const VAPID_KEY_STORAGE = 'mt_vapid_key';

async function initPushNotifications() {
  if (!fbReady || !('Notification' in window) || !('serviceWorker' in navigator)) {
    console.log('Push notifications not supported');
    return;
  }

  try {
    messaging = firebase.messaging();

    // Request notification permission
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      console.log('Notification permission denied');
      updatePushStatus('Notifications blocked ‚Äî enable in browser settings');
      return;
    }

    // Get VAPID key ‚Äî check localStorage first, then wait for Firebase
    let vapidKey = localStorage.getItem(VAPID_KEY_STORAGE);
    if (!vapidKey && fbReady) {
      // Try to load from Firebase (key was set on a different device)
      vapidKey = await new Promise(resolve => {
        db.ref('settings/vapidKey').once('value', snap => {
          const val = snap.val();
          if (val) {
            localStorage.setItem(VAPID_KEY_STORAGE, val);
            const el = document.getElementById('vapidKeyInput');
            if (el) el.value = val;
          }
          resolve(val);
        });
        // Timeout after 5 seconds
        setTimeout(() => resolve(null), 5000);
      });
    }
    if (!vapidKey) {
      console.log('No VAPID key configured yet ‚Äî set it in Settings');
      updatePushStatus('VAPID key needed ‚Äî configure in advanced settings');
      return;
    }

    // Register service worker for FCM
    const swReg = await navigator.serviceWorker.ready;

    // Get FCM token
    const token = await messaging.getToken({
      vapidKey: vapidKey,
      serviceWorkerRegistration: swReg
    });

    if (token) {
      console.log('FCM token:', token);
      // Store token in Firebase so the GitHub Action can find it
      const uid = currentUser?.uid || 'anonymous';
      fbSet('fcmTokens/' + uid, {
        token: token,
        email: currentUser?.email || '',
        updatedAt: new Date().toISOString()
      });
      updatePushStatus('Push notifications active');
    }

    // Handle foreground messages
    messaging.onMessage(payload => {
      console.log('Push received (foreground):', payload);
      // App is open ‚Äî trigger GPS capture
      const todayStr = fmtDate(new Date());
      autoGPSCapture(todayStr);
    });

  } catch(e) {
    console.warn('FCM init error:', e);
    updatePushStatus('Push setup failed: ' + e.message);
  }
}

function updatePushStatus(text) {
  const el = document.getElementById('pushStatus');
  if (el) el.textContent = text;
}

function saveVapidKey() {
  const key = document.getElementById('vapidKeyInput').value.trim();
  if (!key) { toast('Enter a VAPID key'); return; }
  localStorage.setItem(VAPID_KEY_STORAGE, key);
  if (fbReady) fbSet('settings/vapidKey', key);
  toast('VAPID key saved ‚Äî reloading push...');
  initPushNotifications();
}

function loadVapidKey() {
  // Load from Firebase if available
  if (fbReady) {
    fbListen('settings/vapidKey', data => {
      if (data) {
        localStorage.setItem(VAPID_KEY_STORAGE, data);
        const el = document.getElementById('vapidKeyInput');
        if (el) el.value = data;
      }
    });
  }
  const saved = localStorage.getItem(VAPID_KEY_STORAGE) || '';
  const el = document.getElementById('vapidKeyInput');
  if (el) el.value = saved;
}

// Test button for settings
function testMidnightGPS() {
  const todayStr = fmtDate(new Date());
  // Force capture even if already set
  const existing = entries[todayStr];
  if (existing) delete existing.autoGps; // Allow re-capture
  autoGPSCapture(todayStr);
}

// ===== IMPORT/EXPORT =====
async function importSpreadsheet() {
  const file = document.getElementById('importFile').files[0];
  if (!file) { toast('Select a file first'); return; }
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data);
  const ws = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

  let imported = 0;
  const startRow = rows[0]?.[0]?.toString().toLowerCase().includes('date') || rows[0]?.[0]?.toString().includes('Steve') ? 1 : 0;
  const dataStart = rows[startRow]?.[0]?.toString().toLowerCase().includes('date') ? startRow + 1 : startRow;

  for (let i = dataStart; i < rows.length; i++) {
    const row = rows[i];
    if (!row || !row[0]) continue;
    let dateVal = row[0];
    let dateStr;
    if (typeof dateVal === 'number') {
      const d = new Date((dateVal - 25569) * 86400 * 1000);
      dateStr = fmtDate(d);
    } else {
      const d = new Date(dateVal);
      if (isNaN(d.getTime())) continue;
      dateStr = fmtDate(d);
    }
    const place = row[4]?.toString().trim() || '';
    const city = row[5]?.toString().trim() || '';
    const country = row[6]?.toString().trim() || '';
    const flights = row[7]?.toString().trim() || '';
    if (place || city || country) {
      entries[dateStr] = { place, city, country, flights, notes: '', lat: null, lon: null, synced: false };
      imported++;
    }
  }
  saveLocal();
  render();
  toast('Imported ' + imported + ' entries');

  if (fbReady) {
    toast('Syncing ' + imported + ' entries to Firebase...');
    const batch = {};
    Object.entries(entries).filter(([, e]) => !e.synced).forEach(([date, entry]) => {
      batch['locations/' + date] = {
        place: entry.place || '', city: entry.city || '', country: entry.country || '',
        flights: entry.flights || '', notes: entry.notes || '',
        lat: entry.lat || null, lon: entry.lon || null
      };
    });
    if (Object.keys(batch).length > 0) {
      db.ref().update(batch).then(() => {
        Object.values(entries).forEach(e => e.synced = true);
        saveLocal();
        toast('All entries synced to Firebase!');
      }).catch(e => {
        toast('Sync error: ' + e.message);
        console.error(e);
      });
    }
  }
}

function exportCSV() {
  const allDates = Object.keys(entries).sort();
  if (!allDates.length) { toast('No data to export'); return; }
  let csv = 'Date,Day,Place,City,Country,Flights,Notes,Lat,Lon,Working,Source,Conflict\n';
  const daysFull = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  allDates.forEach(ds => {
    const e = entries[ds];
    const d = new Date(ds + 'T00:00:00');
    csv += ds + ',' + daysFull[d.getDay()] + ',' + esc(e.place) + ',' + esc(e.city) + ',' + esc(e.country) + ',' + esc(e.flights) + ',' + esc(e.notes) + ',' + (e.lat||'') + ',' + (e.lon||'') + ',' + (e.working ? 'Yes' : '') + ',' + (e.autoBooking ? 'Booking' : e.autoGps ? 'GPS' : 'Manual') + ',' + esc(e.countryConflict || '') + '\n';
  });
  download(csv, 'midnight-tracker-export-' + fmtDate(new Date()) + '.csv', 'text/csv');
  toast('Exported CSV');
}

function esc(s) { return s && s.includes(',') ? '"' + s + '"' : (s || ''); }
function download(content, name, type) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], { type }));
  a.download = name;
  a.click();
}

// ===== HELPERS =====
function fmtDate(d) {
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function formatDisplayDate(ds) {
  const d = new Date(ds + 'T00:00:00');
  return d.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function render() {
  const active = document.querySelector('.view.active')?.id;
  if (active === 'list') renderList();
  else if (active === 'stats') renderStats();
  else if (active === 'settings') renderPresetsSettings();
}

// ===== INIT =====
const now = new Date();
anchorYear = now.getFullYear();
anchorMonth = now.getMonth();
// Auth state listener (above) will call showApp() ‚Üí loadLocal() + render() + initFirebaseSync()
// If auth is not ready, fall back to showing login
if (!auth) {
  document.getElementById('loginScreen').style.display = 'flex';
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(e => console.warn('SW registration failed', e));

  // Listen for messages from service worker (notification click while app is open)
  navigator.serviceWorker.addEventListener('message', event => {
    if (event.data?.type === 'midnight-gps-capture') {
      console.log('Push notification tapped ‚Äî capturing GPS');
      const todayStr = fmtDate(new Date());
      const existing = entries[todayStr];
      if (existing) delete existing.autoGps; // Force re-capture
      autoGPSCapture(todayStr);
    }
  });
}

// Check URL params for capture flag (opened from notification)
if (window.location.search.includes('capture=midnight')) {
  // Remove the param from URL so it doesn't re-trigger on refresh
  window.history.replaceState({}, '', window.location.pathname);
  // Delay to let auth + Firebase sync happen first
  setTimeout(() => {
    const todayStr = fmtDate(new Date());
    const existing = entries[todayStr];
    if (existing) delete existing.autoGps;
    autoGPSCapture(todayStr);
  }, 4000);
}
</script>
</body>
</html>
