<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Midnight">
<meta name="theme-color" content="#1b2838">
<title>Midnight Tracker</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231b2838'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>üåô</text></svg>">
<link rel="manifest" href="./manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<!-- Firebase SDKs ‚Äî same versions as Chelsea Tickets -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
<!-- XLSX for import -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
/* ===== Design system ‚Äî matches Chelsea Tickets ===== */
:root {
  --primary: #00b8a9;
  --primary-dark: #009e91;
  --primary-light: #e0f7f5;
  --navy: #1b2838;
  --navy-light: #243447;
  --text: #2d3748;
  --text-light: #718096;
  --bg: #f5f7fa;
  --white: #ffffff;
  --border: #e2e8f0;
  --warn: #d97706;
  --warn-bg: #fef3c7;
  --err: #dc2626;
  --err-bg: #fef2f2;
  --ok: #059669;
  --ok-bg: #ecfdf5;
  --blue: #2563eb;
  --blue-bg: #eff6ff;
  --purple: #7c3aed;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; min-height: 100vh; overflow-x: hidden; }
button { cursor: pointer; border: none; font: inherit; color: var(--text); }
input, select, textarea { font: inherit; color: var(--text); background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; }
input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }

/* Header */
.header { background: var(--navy); padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
.header h1 { font-size: 18px; font-weight: 700; color: #fff; }
.header h1 span { color: var(--primary); }
.sync-status { font-size: 12px; color: rgba(255,255,255,.6); display: flex; align-items: center; gap: 4px; }
.sync-dot { width: 8px; height: 8px; border-radius: 50%; }
.sync-dot.ok { background: var(--ok); }
.sync-dot.pending { background: var(--warn); }
.sync-dot.error { background: var(--err); }

/* Tabs */
.tabs { display: flex; background: var(--white); border-bottom: 1px solid var(--border); }
.tab { flex: 1; padding: 12px 10px; text-align: center; background: none; color: var(--text-light); font-size: 13px; font-weight: 500; border-bottom: 2px solid transparent; transition: all .2s; }
.tab:hover { color: var(--text); }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); }

/* Multi-column list */
.list-controls { padding: 10px 16px; display: flex; gap: 8px; align-items: center; background: var(--white); border-bottom: 1px solid var(--border); }
.list-controls select { min-width: 120px; }
.list-controls .spacer { flex: 1; }
.list-controls .month-nav { display: flex; align-items: center; gap: 6px; }
.list-controls .month-nav button { background: var(--white); border: 1px solid var(--border); padding: 4px 10px; border-radius: 6px; font-size: 13px; transition: all .15s; }
.list-controls .month-nav button:hover { border-color: var(--primary); background: var(--primary-light); }
.list-controls .month-nav .current-range { font-size: 13px; font-weight: 600; color: var(--text); min-width: 140px; text-align: center; }

.months-scroll { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; height: calc(100vh - 110px); }
.months-scroll::-webkit-scrollbar { display: none; }
.month-col { min-width: 320px; max-width: 420px; flex: 1 0 320px; scroll-snap-align: start; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
.month-header { padding: 12px 16px; background: var(--bg); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 5; }
.month-header h2 { font-size: 15px; font-weight: 600; }
.month-header .month-summary { font-size: 12px; color: var(--text-light); margin-top: 2px; }
.month-days { flex: 1; overflow-y: auto; }

.list-item { display: flex; padding: 10px 16px; border-bottom: 1px solid var(--border); gap: 12px; cursor: pointer; transition: background .15s; background: var(--white); }
.list-item:hover { background: var(--primary-light); }
.list-item.is-today { background: var(--primary-light); border-left: 3px solid var(--primary); }
.list-item.is-home { opacity: .6; }
.list-date { min-width: 40px; text-align: center; }
.list-date .day-num { font-size: 16px; font-weight: 700; color: var(--primary); }
.list-date .day-name { font-size: 10px; color: var(--text-light); text-transform: uppercase; font-weight: 500; }
.list-info { flex: 1; min-width: 0; }
.list-info .place { font-weight: 500; font-size: 13px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.list-info .city-country { font-size: 12px; color: var(--text-light); }
.list-info .flights { font-size: 11px; color: var(--purple); margin-top: 1px; }
.list-info .working-tag { display: inline-block; font-size: 10px; background: var(--warn-bg); color: var(--warn); padding: 1px 6px; border-radius: 4px; margin-top: 2px; font-weight: 600; }
.list-flag { font-size: 16px; display: flex; align-items: center; }

/* On mobile: single column full width */
@media (max-width: 640px) {
  .month-col { min-width: 100vw; max-width: 100vw; flex: 0 0 100vw; }
}
/* Tablet: 2 columns */
@media (min-width: 641px) and (max-width: 960px) {
  .month-col { min-width: 50vw; max-width: 50vw; flex: 0 0 50vw; }
}
/* Desktop: 3+ columns */
@media (min-width: 961px) {
  .month-col { min-width: 320px; max-width: 380px; }
}

/* Stats */
.stats-container { padding: 16px; }
.stats-year-select { margin-bottom: 16px; }
.stat-card { background: var(--white); border-radius: 10px; border: 1px solid var(--border); padding: 18px; margin-bottom: 12px; }
.stat-card h3 { font-size: 14px; color: var(--text-light); margin-bottom: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: .3px; }
.stat-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
.stat-row .country { font-weight: 500; }
.stat-row .days { color: var(--primary); font-weight: 700; }
.stat-bar { height: 6px; background: var(--bg); border-radius: 3px; margin-top: 4px; }
.stat-bar-fill { height: 100%; border-radius: 3px; background: var(--primary); transition: width .5s; }

/* Modal */
.modal-bg { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4); z-index: 200; align-items: flex-end; justify-content: center; }
.modal-bg.open { display: flex; }
.modal { background: var(--white); border-radius: 16px 16px 0 0; width: 100%; max-width: 500px; max-height: 85vh; overflow-y: auto; padding: 24px; box-shadow: 0 -8px 30px rgba(0,0,0,.15); }
.modal h2 { font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
.modal h2 button { background: none; font-size: 24px; color: var(--text-light); }
.field { margin-bottom: 14px; }
.field label { display: block; font-size: 13px; color: var(--text-light); margin-bottom: 4px; font-weight: 500; }
.field input, .field select, .field textarea { width: 100%; }
.btn { padding: 10px 20px; border-radius: 8px; font-weight: 500; font-size: 14px; transition: all .15s; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-danger { background: var(--err); color: #fff; }
.btn-outline { background: var(--white); border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover { background: var(--bg); }
.btn-row { display: flex; gap: 8px; margin-top: 16px; }
.btn-row .btn { flex: 1; }

/* Settings */
.settings-section { padding: 16px; }
.settings-section h3 { font-size: 14px; color: var(--text-light); margin-bottom: 12px; font-weight: 500; }
.settings-card { background: var(--white); border-radius: 10px; border: 1px solid var(--border); padding: 18px; margin-bottom: 16px; }
.settings-card h3 { font-size: 15px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
.settings-card p { font-size: 13px; color: var(--text-light); margin-bottom: 8px; }

/* Toast */
.toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--navy); color: #fff; padding: 12px 20px; border-radius: 8px; font-size: 14px; z-index: 300; opacity: 0; transition: opacity .3s; pointer-events: none; box-shadow: 0 8px 24px rgba(0,0,0,.2); }
.toast.show { opacity: 1; }

/* Sections */
.view { display: none; }
.view.active { display: block; }

/* GPS button */
.gps-btn { position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background: var(--primary); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0,184,169,.4); z-index: 50; transition: background .15s; }
.gps-btn:hover { background: var(--primary-dark); }

@media (min-width: 768px) {
  .modal { border-radius: 16px; margin-bottom: 20px; }
}
</style>
</head>
<body>

<div class="header">
  <h1>üåô <span>Midnight</span> Tracker</h1>
  <div class="sync-status" id="syncStatus"><div class="sync-dot pending"></div>Connecting...</div>
</div>

<div class="tabs">
  <button class="tab active" data-view="list">Location</button>
  <button class="tab" data-view="stats">Tax Stats</button>
  <button class="tab" data-view="settings">Settings</button>
</div>

<!-- LIST VIEW (default, multi-column) -->
<div id="list" class="view active">
  <div class="list-controls">
    <select id="listCountryFilter"><option value="">All countries</option></select>
    <div class="spacer"></div>
    <div class="month-nav">
      <button onclick="scrollMonths(-1)">‚óÄ</button>
      <span class="current-range" id="monthRange"></span>
      <button onclick="scrollMonths(1)">‚ñ∂</button>
    </div>
  </div>
  <div class="months-scroll" id="monthsScroll"></div>
</div>

<!-- STATS VIEW -->
<div id="stats" class="view">
  <div class="stats-container">
    <select class="stats-year-select" id="statsYear" style="width:100%;margin-bottom:16px;"></select>
    <div id="statsContent"></div>
  </div>
</div>

<!-- SETTINGS VIEW -->
<div id="settings" class="view">
  <div class="settings-section">
    <div class="settings-card">
      <h3>Firebase Connection</h3>
      <p id="fbStatus" style="margin-bottom:8px;">Checking connection...</p>
      <button class="btn btn-primary" onclick="testFirebase()" style="width:100%">Test Connection</button>
    </div>

    <div class="settings-card">
      <h3>Import Spreadsheet</h3>
      <p>Import your existing Excel tracking spreadsheet. Format: Date | Day | Month | Year | Place | City | Country | Flights</p>
      <input type="file" id="importFile" accept=".xlsx,.csv" style="width:100%;margin-bottom:8px;" />
      <button class="btn btn-primary" onclick="importSpreadsheet()" style="width:100%">Import Data</button>
    </div>

    <div class="settings-card">
      <h3>Export Data</h3>
      <button class="btn btn-outline" onclick="exportCSV()" style="width:100%">Export as CSV</button>
    </div>

    <div class="settings-card">
      <h3>Primary Home</h3>
      <p>Your primary home is <strong>Cernobbio, Italy</strong>. Days without a location entry are counted as home days.</p>
    </div>
  </div>
</div>

<!-- EDIT MODAL -->
<div class="modal-bg" id="editModal">
  <div class="modal">
    <h2><span id="modalDate"></span><button onclick="closeModal()">&times;</button></h2>
    <div class="field">
      <label>Place / Hotel</label>
      <input id="editPlace" placeholder="e.g. Hotel Negresco" />
    </div>
    <div class="field">
      <label>City</label>
      <input id="editCity" placeholder="e.g. Nice" />
    </div>
    <div class="field">
      <label>Country</label>
      <input id="editCountry" placeholder="e.g. France" />
    </div>
    <div class="field">
      <label>Flights</label>
      <input id="editFlights" placeholder="e.g. BA569" />
    </div>
    <div class="field">
      <label>Notes</label>
      <textarea id="editNotes" rows="2" placeholder="Optional notes..."></textarea>
    </div>
    <div class="field" id="workingField">
      <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
        <input type="checkbox" id="editWorking" style="width:18px;height:18px;accent-color:var(--primary);flex:none;" />
        <span>Worked in the UK this day</span>
      </label>
      <div style="font-size:11px;color:var(--text-light);margin-top:4px;">Tag days where you performed work in the UK (30-day annual limit)</div>
    </div>
    <div class="field">
      <label>GPS Coordinates</label>
      <div style="display:flex;gap:8px;">
        <input id="editLat" placeholder="Lat" style="flex:1" type="number" step="any" />
        <input id="editLon" placeholder="Lon" style="flex:1" type="number" step="any" />
        <button class="btn btn-outline" onclick="captureGPS()" style="flex:0 0 auto;">üìç</button>
      </div>
    </div>
    <div class="btn-row">
      <button class="btn btn-outline" onclick="clearDay()">Clear</button>
      <button class="btn btn-primary" onclick="saveDay()">Save</button>
    </div>
  </div>
</div>

<!-- GPS FAB -->
<button class="gps-btn" onclick="captureTodayGPS()" title="Capture GPS for today">üìç</button>

<div class="toast" id="toast"></div>

<script>
// ===== FIREBASE CONFIG =====
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyAjZaVwXku1n1niJtkxvcKjXDHibSHHIRc",
  authDomain: "midnight-tracker-steve.firebaseapp.com",
  databaseURL: "https://midnight-tracker-steve-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "midnight-tracker-steve",
  storageBucket: "midnight-tracker-steve.firebasestorage.app",
  messagingSenderId: "860824921259",
  appId: "1:860824921259:web:b1c462b04dc3bf18ae03ee"
};

// ===== FIREBASE INIT =====
let db = null;
let fbReady = false;
try {
  if (FIREBASE_CONFIG.apiKey !== 'YOUR_API_KEY') {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.database();
    fbReady = true;
  }
} catch(e) { console.warn('Firebase init failed:', e); }

function fbSet(path, val) { if (db) db.ref(path).set(val); }
function fbUpdate(path, val) { if (db) db.ref(path).update(val); }
function fbRemove(path) { if (db) db.ref(path).remove(); }
function fbListen(path, cb) {
  if (db) db.ref(path).on('value', snap => { const v = snap.val(); cb(v); });
}

// ===== STATE =====
const HOME = { city: 'Cernobbio', country: 'Italy', place: 'Home' };
let entries = {};
let editingDate = null;

// The "anchor" month for the scroll ‚Äî current month by default
let anchorYear, anchorMonth;
// How many months to show at once (we render a window of months)
const MONTHS_BUFFER = 6; // 3 past + current + 2 future
let scrollOffset = 0; // 0 = current month is first column

// ===== SYNC STATUS =====
function setSyncStatus(state, text) {
  const el = document.getElementById('syncStatus');
  el.innerHTML = '<div class="sync-dot ' + state + '"></div>' + text;
}

function testFirebase() {
  const statusEl = document.getElementById('fbStatus');
  if (!fbReady) {
    statusEl.textContent = 'Firebase not configured. Edit FIREBASE_CONFIG in index.html.';
    statusEl.style.color = 'var(--err)';
    return;
  }
  statusEl.textContent = 'Testing connection...';
  statusEl.style.color = 'var(--warn)';
  db.ref('.info/connected').once('value', snap => {
    if (snap.val() === true) {
      statusEl.textContent = 'Connected to Firebase (' + FIREBASE_CONFIG.projectId + ')';
      statusEl.style.color = 'var(--ok)';
    } else {
      statusEl.textContent = 'Firebase initialised but not connected yet.';
      statusEl.style.color = 'var(--warn)';
    }
  });
}

// ===== LOCAL STORAGE =====
function saveLocal() { localStorage.setItem('mt_entries', JSON.stringify(entries)); }
function loadLocal() {
  try { entries = JSON.parse(localStorage.getItem('mt_entries') || '{}'); } catch { entries = {}; }
}

// ===== FIREBASE SYNC =====
function initFirebaseSync() {
  if (!fbReady) {
    setSyncStatus('error', 'Not configured');
    document.getElementById('fbStatus').textContent = 'Firebase not configured. Edit FIREBASE_CONFIG in index.html.';
    document.getElementById('fbStatus').style.color = 'var(--err)';
    return;
  }
  setSyncStatus('pending', 'Syncing...');
  fbListen('locations', data => {
    if (data) {
      const newEntries = {};
      Object.keys(data).forEach(dateKey => {
        newEntries[dateKey] = { ...data[dateKey], synced: true };
      });
      entries = newEntries;
    } else {
      entries = {};
    }
    saveLocal();
    setSyncStatus('ok', 'Synced');
    render();
  });
  db.ref('.info/connected').on('value', snap => {
    if (snap.val() === true) {
      setSyncStatus('ok', 'Connected');
    } else {
      setSyncStatus('pending', 'Reconnecting...');
    }
  });
}

function syncEntry(date, entry) {
  if (!fbReady) return;
  const data = {
    place: entry.place || '', city: entry.city || '', country: entry.country || '',
    flights: entry.flights || '', notes: entry.notes || ''
  };
  if (entry.lat) data.lat = entry.lat;
  if (entry.lon) data.lon = entry.lon;
  if (entry.working) data.working = true;
  fbSet('locations/' + date, data);
  entry.synced = true;
  saveLocal();
}

function deleteEntry(date) {
  if (fbReady) fbRemove('locations/' + date);
}

// ===== TABS =====
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById(tab.dataset.view).classList.add('active');
    render();
  });
});

// ===== MULTI-COLUMN LIST =====
const MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const DAY_NAMES = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

function getMonthKey(y, m) { return y + '-' + String(m + 1).padStart(2, '0'); }

function scrollMonths(dir) {
  scrollOffset += dir;
  renderList();
}

function renderList() {
  const container = document.getElementById('monthsScroll');
  const countryFilter = document.getElementById('listCountryFilter').value;
  const todayStr = fmtDate(new Date());

  // Populate country filter
  const countries = [...new Set(Object.values(entries).map(e => e.country).filter(Boolean))].sort();
  const sel = document.getElementById('listCountryFilter');
  const current = sel.value;
  sel.innerHTML = '<option value="">All countries</option>' + countries.map(c => '<option value="' + c + '"' + (c === current ? ' selected' : '') + '>' + c + '</option>').join('');

  // Build months array: scrollOffset controls which month is first
  // scrollOffset 0 = current month first, -1 = last month first, +1 = next month first
  let html = '';
  const startY = anchorYear;
  const startM = anchorMonth;

  for (let i = 0; i < MONTHS_BUFFER; i++) {
    let mOffset = scrollOffset + i;
    let y = startY;
    let m = startM + mOffset;
    // Normalise month/year
    while (m > 11) { m -= 12; y++; }
    while (m < 0) { m += 12; y--; }

    const daysInMonth = new Date(y, m + 1, 0).getDate();
    let monthHtml = '';
    let awayDays = 0;
    let homeDays = 0;

    for (let d = 1; d <= daysInMonth; d++) {
      const ds = y + '-' + String(m + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
      const dt = new Date(y, m, d);
      const entry = entries[ds];
      const place = entry?.place || HOME.place;
      const city = entry?.city || HOME.city;
      const country = entry?.country || HOME.country;
      const flights = entry?.flights || '';
      const flag = entry?.country ? countryFlag(entry.country) : countryFlag(HOME.country);
      const isHome = (!entry) || (entry.country === 'Italy' && entry.city === 'Cernobbio');
      const isToday = ds === todayStr;

      if (isHome) homeDays++; else awayDays++;
      if (countryFilter && country !== countryFilter) continue;

      let cls = 'list-item';
      if (isToday) cls += ' is-today';
      if (isHome) cls += ' is-home';

      const isWorking = entry?.working;
      monthHtml += '<div class="' + cls + '" onclick="openDay(\'' + ds + '\')">' +
        '<div class="list-date"><div class="day-num">' + d + '</div><div class="day-name">' + DAY_NAMES[dt.getDay()] + '</div></div>' +
        '<div class="list-info"><div class="place">' + place + '</div><div class="city-country">' + city + (country ? ', ' + country : '') + '</div>' +
        (flights ? '<div class="flights">‚úà ' + flights + '</div>' : '') +
        (isWorking ? '<div class="working-tag">WORKING</div>' : '') + '</div>' +
        '<div class="list-flag">' + flag + '</div>' +
      '</div>';
    }

    html += '<div class="month-col">' +
      '<div class="month-header"><h2>' + MONTH_NAMES[m] + ' ' + y + '</h2>' +
      '<div class="month-summary">' + awayDays + ' away ¬∑ ' + homeDays + ' home</div></div>' +
      '<div class="month-days">' + (monthHtml || '<p style="padding:16px;color:var(--text-light)">No entries</p>') + '</div>' +
    '</div>';
  }

  container.innerHTML = html;

  // Update range label
  let firstM = startM + scrollOffset;
  let firstY = startY;
  while (firstM > 11) { firstM -= 12; firstY++; }
  while (firstM < 0) { firstM += 12; firstY--; }
  document.getElementById('monthRange').textContent = MONTH_NAMES[firstM].slice(0, 3) + ' ' + firstY;
}

document.getElementById('listCountryFilter').addEventListener('change', renderList);

function countryFlag(country) {
  const map = {
    'Italy':'üáÆüáπ','UK':'üá¨üáß','Thailand':'üáπüá≠','Japan':'üáØüáµ','Taiwan':'üáπüáº',
    'India':'üáÆüá≥','Switzerland':'üá®üá≠','France':'üá´üá∑','Germany':'üá©üá™','Spain':'üá™üá∏',
    'USA':'üá∫üá∏','United States':'üá∫üá∏','China':'üá®üá≥','Australia':'üá¶üá∫','Canada':'üá®üá¶',
    'Singapore':'üá∏üá¨','UAE':'üá¶üá™','Netherlands':'üá≥üá±','Portugal':'üáµüáπ','Greece':'üá¨üá∑',
    'Turkey':'üáπüá∑','Brazil':'üáßüá∑','Mexico':'üá≤üáΩ','South Korea':'üá∞üá∑','Indonesia':'üáÆüá©',
    'Malaysia':'üá≤üáæ','Vietnam':'üáªüá≥','Philippines':'üáµüá≠','Hong Kong':'üá≠üá∞',
  };
  return map[country] || 'üè≥Ô∏è';
}

// ===== STATS (UK Tax Year: 6 Apr ‚Äì 5 Apr) =====

// Get tax year label from a start year, e.g. 2025 => "2025/26"
function taxYearLabel(startYear) {
  return startYear + '/' + String(startYear + 1).slice(2);
}

// Tax year start: 6 April of startYear. End: 5 April of startYear+1.
function taxYearDates(startYear) {
  return {
    start: new Date(startYear, 3, 6),  // 6 April
    end: new Date(startYear + 1, 3, 5) // 5 April next year
  };
}

// Total days in a tax year (365 or 366 depending on whether it spans a leap year)
function taxYearTotalDays(startYear) {
  const { start, end } = taxYearDates(startYear);
  return Math.round((end - start) / 86400000) + 1;
}

// Which tax year does today fall in?
function currentTaxYear() {
  const now = new Date();
  // If before 6 April, we're in the tax year that started last year
  if (now.getMonth() < 3 || (now.getMonth() === 3 && now.getDate() < 6)) {
    return now.getFullYear() - 1;
  }
  return now.getFullYear();
}

function renderStats() {
  const sel = document.getElementById('statsYear');
  // Build list of tax years from data
  const dataYears = Object.keys(entries).map(d => {
    const dt = new Date(d + 'T00:00:00');
    if (dt.getMonth() < 3 || (dt.getMonth() === 3 && dt.getDate() < 6)) return dt.getFullYear() - 1;
    return dt.getFullYear();
  });
  const taxYears = [...new Set([currentTaxYear(), ...dataYears])].sort().reverse();

  if (!sel.options.length || sel.dataset.count !== String(taxYears.length)) {
    sel.innerHTML = taxYears.map(y => '<option value="' + y + '">' + taxYearLabel(y) + ' (6 Apr ' + y + ' ‚Äì 5 Apr ' + (y+1) + ')</option>').join('');
    sel.value = currentTaxYear();
    sel.dataset.count = String(taxYears.length);
  }

  const startYear = parseInt(sel.value);
  const { start: taxStart, end: taxEnd } = taxYearDates(startYear);
  const today = new Date();
  const lastDay = taxEnd < today ? taxEnd : today;
  const totalTaxDays = taxYearTotalDays(startYear);

  // Count days per country within the tax year
  const countryCounts = {};
  let daysElapsed = 0;
  let ukNights = 0;
  let italyDays = 0;
  let ukWorkDays = 0;

  for (let d = new Date(taxStart); d <= lastDay; d.setDate(d.getDate() + 1)) {
    const ds = fmtDate(d);
    const entry = entries[ds];
    const country = entry?.country || HOME.country;
    countryCounts[country] = (countryCounts[country] || 0) + 1;
    daysElapsed++;
    if (country === 'UK') ukNights++;
    if (country === 'Italy') italyDays++;
    if (entry?.working) ukWorkDays++;
  }

  const daysRemaining = totalTaxDays - daysElapsed;
  const sorted = Object.entries(countryCounts).sort((a, b) => b[1] - a[1]);
  const maxDays = sorted[0]?.[1] || 1;

  // ‚îÄ‚îÄ Country breakdown ‚îÄ‚îÄ
  let html = '<div class="stat-card"><h3>Midnights per Country ‚Äî Tax Year ' + taxYearLabel(startYear) + '</h3>';
  html += '<div style="font-size:12px;color:var(--text-light);margin-bottom:10px;">' + daysElapsed + ' days elapsed ¬∑ ' + daysRemaining + ' days remaining</div>';
  sorted.forEach(([country, days]) => {
    const pct = ((days / daysElapsed) * 100).toFixed(1);
    const barW = ((days / maxDays) * 100).toFixed(0);
    const flag = countryFlag(country);
    html += '<div class="stat-row"><span class="country">' + flag + ' ' + country + '</span><span class="days">' + days + ' nights (' + pct + '%)</span></div>' +
            '<div class="stat-bar"><div class="stat-bar-fill" style="width:' + barW + '%"></div></div>';
  });
  html += '</div>';

  // ‚îÄ‚îÄ Italy 183-day target ‚îÄ‚îÄ
  const italyProjected = daysElapsed > 0 ? Math.round((italyDays / daysElapsed) * totalTaxDays) : 0;
  const italyNeeded = Math.max(0, 183 - italyDays);
  const italyOnTrack = italyProjected >= 183;
  const italyPct = ((italyDays / 183) * 100).toFixed(0);

  html += '<div class="stat-card"><h3>üáÆüáπ Italy ‚Äî 183-Day Residency Target</h3>';
  html += '<div class="stat-bar" style="height:10px;margin-bottom:12px;"><div class="stat-bar-fill" style="width:' + Math.min(100, italyPct) + '%;background:' + (italyOnTrack ? 'var(--ok)' : 'var(--warn)') + '"></div></div>';
  html += '<div class="stat-row"><span>Nights in Italy (actual)</span><span class="days">' + italyDays + ' / 183</span></div>';
  html += '<div class="stat-row"><span>Projected full tax year</span><span class="days" style="color:' + (italyOnTrack ? 'var(--ok)' : 'var(--warn)') + '">' + italyProjected + '</span></div>';
  if (italyNeeded > 0) {
    html += '<div class="stat-row"><span>Still needed</span><span class="days" style="color:var(--warn)">' + italyNeeded + ' more nights</span></div>';
    if (daysRemaining > 0) {
      const italyPaceNeeded = (italyNeeded / daysRemaining * 100).toFixed(0);
      html += '<div class="stat-row"><span>Required pace</span><span style="color:var(--text-light)">' + italyPaceNeeded + '% of remaining days in Italy</span></div>';
    }
  } else {
    html += '<div class="stat-row"><span>Status</span><span class="days" style="color:var(--ok)">‚úì Target met!</span></div>';
  }
  html += '</div>';

  // ‚îÄ‚îÄ UK 90-night limit ‚îÄ‚îÄ
  const ukProjected = daysElapsed > 0 ? Math.round((ukNights / daysElapsed) * totalTaxDays) : 0;
  const ukRemaining = Math.max(0, 90 - ukNights);
  const ukSafe = ukProjected <= 90;
  const ukPct = ((ukNights / 90) * 100).toFixed(0);

  html += '<div class="stat-card"><h3>üá¨üáß UK ‚Äî 90-Night Limit</h3>';
  html += '<div class="stat-bar" style="height:10px;margin-bottom:12px;"><div class="stat-bar-fill" style="width:' + Math.min(100, ukPct) + '%;background:' + (ukNights > 90 ? 'var(--err)' : ukSafe ? 'var(--ok)' : 'var(--warn)') + '"></div></div>';
  html += '<div class="stat-row"><span>UK midnights (actual)</span><span class="days">' + ukNights + ' / 90</span></div>';
  html += '<div class="stat-row"><span>Projected full tax year</span><span class="days" style="color:' + (ukSafe ? 'var(--ok)' : 'var(--err)') + '">' + ukProjected + '</span></div>';
  if (ukNights > 90) {
    html += '<div class="stat-row"><span>Status</span><span class="days" style="color:var(--err)">‚ö† LIMIT EXCEEDED by ' + (ukNights - 90) + ' nights</span></div>';
  } else {
    html += '<div class="stat-row"><span>Nights remaining</span><span class="days">' + ukRemaining + ' UK nights available</span></div>';
    if (daysRemaining > 0 && ukRemaining > 0) {
      const avgDaysBetweenUK = Math.round(daysRemaining / ukRemaining);
      html += '<div class="stat-row"><span>Budget</span><span style="color:var(--text-light)">~1 UK night every ' + avgDaysBetweenUK + ' days</span></div>';
    }
  }
  html += '</div>';

  // ‚îÄ‚îÄ UK 30-day working limit ‚îÄ‚îÄ
  const ukWorkRemaining = Math.max(0, 30 - ukWorkDays);
  const ukWorkProjected = daysElapsed > 0 ? Math.round((ukWorkDays / daysElapsed) * totalTaxDays) : 0;
  const ukWorkSafe = ukWorkProjected <= 30;
  const ukWorkPct = ((ukWorkDays / 30) * 100).toFixed(0);

  html += '<div class="stat-card"><h3>üá¨üáß UK ‚Äî 30-Day Working Limit</h3>';
  html += '<div class="stat-bar" style="height:10px;margin-bottom:12px;"><div class="stat-bar-fill" style="width:' + Math.min(100, ukWorkPct) + '%;background:' + (ukWorkDays > 30 ? 'var(--err)' : ukWorkSafe ? 'var(--ok)' : 'var(--warn)') + '"></div></div>';
  html += '<div class="stat-row"><span>UK working days (actual)</span><span class="days">' + ukWorkDays + ' / 30</span></div>';
  html += '<div class="stat-row"><span>Projected full tax year</span><span class="days" style="color:' + (ukWorkSafe ? 'var(--ok)' : 'var(--err)') + '">' + ukWorkProjected + '</span></div>';
  if (ukWorkDays > 30) {
    html += '<div class="stat-row"><span>Status</span><span class="days" style="color:var(--err)">‚ö† LIMIT EXCEEDED by ' + (ukWorkDays - 30) + ' days</span></div>';
  } else {
    html += '<div class="stat-row"><span>Days remaining</span><span class="days">' + ukWorkRemaining + ' UK work days available</span></div>';
  }
  html += '<div style="font-size:11px;color:var(--text-light);margin-top:8px;">Tag UK working days in the edit modal (defaults to not working)</div>';
  html += '</div>';

  document.getElementById('statsContent').innerHTML = html;
}

document.getElementById('statsYear').addEventListener('change', renderStats);

// ===== MODAL =====
function openDay(dateStr) {
  editingDate = dateStr;
  const entry = entries[dateStr] || {};
  document.getElementById('modalDate').textContent = formatDisplayDate(dateStr);
  document.getElementById('editPlace').value = entry.place || '';
  document.getElementById('editCity').value = entry.city || '';
  document.getElementById('editCountry').value = entry.country || '';
  document.getElementById('editFlights').value = entry.flights || '';
  document.getElementById('editNotes').value = entry.notes || '';
  document.getElementById('editLat').value = entry.lat || '';
  document.getElementById('editLon').value = entry.lon || '';
  document.getElementById('editWorking').checked = !!entry.working;
  document.getElementById('editModal').classList.add('open');
}

function closeModal() {
  document.getElementById('editModal').classList.remove('open');
  editingDate = null;
}

function saveDay() {
  if (!editingDate) return;
  const savedDate = editingDate;
  const country = document.getElementById('editCountry').value.trim();
  const entry = {
    place: document.getElementById('editPlace').value.trim(),
    city: document.getElementById('editCity').value.trim(),
    country: country,
    flights: document.getElementById('editFlights').value.trim(),
    notes: document.getElementById('editNotes').value.trim(),
    lat: parseFloat(document.getElementById('editLat').value) || null,
    lon: parseFloat(document.getElementById('editLon').value) || null,
    working: document.getElementById('editWorking').checked ? true : false,
    synced: false
  };
  if (entry.place || entry.city || entry.country) {
    entries[savedDate] = entry;
    syncEntry(savedDate, entry);
  }
  saveLocal();
  closeModal();
  render();
  toast('Saved ' + formatDisplayDate(savedDate));
}

function clearDay() {
  if (!editingDate) return;
  const savedDate = editingDate;
  delete entries[savedDate];
  deleteEntry(savedDate);
  saveLocal();
  closeModal();
  render();
  toast('Cleared ' + formatDisplayDate(savedDate));
}

// ===== GPS =====
function captureGPS() {
  if (!navigator.geolocation) { toast('GPS not available'); return; }
  navigator.geolocation.getCurrentPosition(
    pos => {
      document.getElementById('editLat').value = pos.coords.latitude.toFixed(6);
      document.getElementById('editLon').value = pos.coords.longitude.toFixed(6);
      toast('GPS captured');
    },
    err => toast('GPS error: ' + err.message),
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

function captureTodayGPS() {
  if (!navigator.geolocation) { toast('GPS not available'); return; }
  navigator.geolocation.getCurrentPosition(
    async pos => {
      const todayStr = fmtDate(new Date());
      const entry = entries[todayStr] || {};
      entry.lat = pos.coords.latitude;
      entry.lon = pos.coords.longitude;
      if (!entry.city) {
        try {
          const r = await fetch('https://nominatim.openstreetmap.org/reverse?lat=' + pos.coords.latitude + '&lon=' + pos.coords.longitude + '&format=json');
          const data = await r.json();
          entry.city = data.address?.city || data.address?.town || data.address?.village || '';
          entry.country = data.address?.country || '';
          entry.place = data.display_name?.split(',')[0] || '';
        } catch(e) { console.warn('Geocode failed', e); }
      }
      entries[todayStr] = entry;
      saveLocal();
      syncEntry(todayStr, entry);
      render();
      toast('GPS: ' + (entry.city || pos.coords.latitude.toFixed(4)) + ', ' + (entry.country || pos.coords.longitude.toFixed(4)));
    },
    err => toast('GPS error: ' + err.message),
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

// ===== IMPORT/EXPORT =====
async function importSpreadsheet() {
  const file = document.getElementById('importFile').files[0];
  if (!file) { toast('Select a file first'); return; }
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data);
  const ws = wb.Sheets[wb.SheetNames[0]];
  const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

  let imported = 0;
  const startRow = rows[0]?.[0]?.toString().toLowerCase().includes('date') || rows[0]?.[0]?.toString().includes('Steve') ? 1 : 0;
  const dataStart = rows[startRow]?.[0]?.toString().toLowerCase().includes('date') ? startRow + 1 : startRow;

  for (let i = dataStart; i < rows.length; i++) {
    const row = rows[i];
    if (!row || !row[0]) continue;
    let dateVal = row[0];
    let dateStr;
    if (typeof dateVal === 'number') {
      const d = new Date((dateVal - 25569) * 86400 * 1000);
      dateStr = fmtDate(d);
    } else {
      const d = new Date(dateVal);
      if (isNaN(d.getTime())) continue;
      dateStr = fmtDate(d);
    }
    const place = row[4]?.toString().trim() || '';
    const city = row[5]?.toString().trim() || '';
    const country = row[6]?.toString().trim() || '';
    const flights = row[7]?.toString().trim() || '';
    if (place || city || country) {
      entries[dateStr] = { place, city, country, flights, notes: '', lat: null, lon: null, synced: false };
      imported++;
    }
  }
  saveLocal();
  render();
  toast('Imported ' + imported + ' entries');

  if (fbReady) {
    toast('Syncing ' + imported + ' entries to Firebase...');
    const batch = {};
    Object.entries(entries).filter(([, e]) => !e.synced).forEach(([date, entry]) => {
      batch['locations/' + date] = {
        place: entry.place || '', city: entry.city || '', country: entry.country || '',
        flights: entry.flights || '', notes: entry.notes || '',
        lat: entry.lat || null, lon: entry.lon || null
      };
    });
    if (Object.keys(batch).length > 0) {
      db.ref().update(batch).then(() => {
        Object.values(entries).forEach(e => e.synced = true);
        saveLocal();
        toast('All entries synced to Firebase!');
      }).catch(e => {
        toast('Sync error: ' + e.message);
        console.error(e);
      });
    }
  }
}

function exportCSV() {
  const allDates = Object.keys(entries).sort();
  if (!allDates.length) { toast('No data to export'); return; }
  let csv = 'Date,Day,Place,City,Country,Flights,Notes,Lat,Lon\n';
  const daysFull = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  allDates.forEach(ds => {
    const e = entries[ds];
    const d = new Date(ds + 'T00:00:00');
    csv += ds + ',' + daysFull[d.getDay()] + ',' + esc(e.place) + ',' + esc(e.city) + ',' + esc(e.country) + ',' + esc(e.flights) + ',' + esc(e.notes) + ',' + (e.lat||'') + ',' + (e.lon||'') + '\n';
  });
  download(csv, 'midnight-tracker-export-' + fmtDate(new Date()) + '.csv', 'text/csv');
  toast('Exported CSV');
}

function esc(s) { return s && s.includes(',') ? '"' + s + '"' : (s || ''); }
function download(content, name, type) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([content], { type }));
  a.download = name;
  a.click();
}

// ===== HELPERS =====
function fmtDate(d) {
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function formatDisplayDate(ds) {
  const d = new Date(ds + 'T00:00:00');
  return d.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
}

function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

function render() {
  const active = document.querySelector('.view.active')?.id;
  if (active === 'list') renderList();
  else if (active === 'stats') renderStats();
}

// ===== INIT =====
loadLocal();
const now = new Date();
anchorYear = now.getFullYear();
anchorMonth = now.getMonth();
render();
initFirebaseSync();

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(e => console.warn('SW registration failed', e));
}
</script>
</body>
</html>
